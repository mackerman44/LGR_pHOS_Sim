---
title: "Tagging Rate at Lower Granite Dam"
author:
- Kevin See^[Biomark, Inc.]
- Mike Ackerman^[Biomark, Inc.]
- Kyle Meier^[Biomark, Inc.]
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  html_document:
    theme: cerulean
    toc: yes
    toc_depth: 1
    toc_float: yes
---

```{r setup, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
# library(knitr)
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)

library(pander)
# options for table formatting
panderOptions('big.mark', ',')
# panderOptions('digits', 3)
# panderOptions('round', 3)
panderOptions('keep.trailing.zeros', FALSE)
panderOptions('table.split.table', Inf)

library(captioner)
tab_nums = captioner(prefix = 'Table')
fig_nums = captioner()

# load packages for analysis
library(tidyverse)
library(readxl)
library(scales)
library(janitor)

theme_set(theme_bw())
# setwd('trap_rate')
```

```{r captions}
remove_tab = tab_nums('remove_tab',
                      'Populations, by species, with a low number of total tags deployed at LGR detected within. These populations were further examined as to whether low detections were due to true low population size or infrastructure not intended for population monitoring. Species, TRT population, and year combinations containing a [Y] were removed from analysis because IPTDS did not exists or were not intended for population monitoring.')

n_tags_vs_cv_fig = fig_nums('n_tags_vs_cv_fig',
                            'Scatterplot of the number of PIT tags detected in each population and the CV of the
abundance estimate for that population. The lines are GLM and Loess fits to the data. The dashed horizontal line denotes a CV of 15%.')

perc_tags_vs_cv_fig = fig_nums('perc_tags_vs_cv_fig',
                               'Scatterplot of the proportion of PIT tags detected in each population and the CV of the abundance estimate for that population. The lines are GLM and Loess fits to that data. The dashed horizontal line denotes a CV of 15%.')

n_tags_tab = tab_nums('n_tags_tab',
                      'Estimated number of PIT tags that need to be detected within a TRT population to achieve a CV of 15% or less for abundance estimates.')

prop_tags_tab = tab_nums('prop_tags_tab',
                         'The estimated proportion of total tags deployed at LGR that need to be detected within a TRT population to achieve a CV of 15% or less for abundance estimates.')

tag50_fig = fig_nums('tag50_fig',
                     'The number of PIT tags detected in a TRT population and the corresponding population abundance estimate, by species, using results back to spawn year 2013. Estimates shown in blue had a CV of 15% or less. The dashed vertical line denotes 50 PIT tags detected.')

prop_tags_lgr_fig = fig_nums('prop_tags_lgr_fig',
                             'The proportion of tags detected within a TRT population each year, by species.')

prop_det_tab = tab_nums('prop_det_tab',
                        'The average proportion of tags deployed at LGR detected in a TRT population, by species.')

lgr_tags_needed = tab_nums('lgr_tags_needed',
                           'The expected number of tags needed to be deployed at LGR to achieve a minimum number of detections in each TRT population leading to reasonably precise estimate of abundance.')

perc_good_cv = fig_nums('perc_good_cv',
                        'Expected proportion of TRT populations with a good CV of abundance estimates for a given number of PIT tags deployed at LGR, colored by species.')

```

# Introduction

We are interested in determining the relationship between the number of PIT tags implanted in adults at Lower Granite Dam (LGR) and the precision of abundance estimates at the technical recovery team (TRT) population scale for Snake River Basin spring/summer Chinook salmon ESU and steelhead DPS. The number of PIT tags to implant at LGR can then be used to make inferences about trapping and tagging rates. We further consider the precision of sex and age (total) specific estimates for each population, which are necessary for estimating population productivity (e.g., recruits per spawner/female).

```{r read_in_est}
AbundanceFolder = '../../SnakeBasinFishStatus/Abundance_results' # for processed files

pop_est = c('Chinook', 'Steelhead') %>%
  as.list() %>%
  set_names() %>%
  map_df(.f = function(x) {
    read_excel(paste0(AbundanceFolder, '/LGR_AllSummaries_', x, '.xlsx'))
  }) %>%
  filter(!is.na(n_tags)) %>%
  mutate_at(vars(spawn_yr:TRT),
            list(as.factor)) %>%
  mutate_at(vars(cv),
            list(as.numeric)) %>%
  rename(Species = species)
```

```{r read_in_sites}
# which sites are attached to which TRT populations?
site_pop = c('Chinook', 'Steelhead') %>%
  as.list() %>%
  set_names() %>%
  map_df(.id = 'Species',
         .f = function(x) read_csv(paste0('../data/Site_TRT_', x, '.csv')))

```

```{r}
# determine which populations don't have good detection infrastructure to make estimates

# this populations have a single detection site
single_site_pops = site_pop %>%
  group_by(Species, TRT, POP_NAME) %>%
  summarise(n_sites = n_distinct(SiteID)) %>%
  arrange(Species, n_sites) %>%
  filter(n_sites == 1) %>%
  left_join(site_pop %>%
              select(Species, TRT, SiteID:SiteName) %>%
              distinct()) %>%
  select(-n_sites)


# site_pop %>%
#   group_by(Species, TRT, POP_NAME) %>%
#   summarise(n_sites = n_distinct(SiteID)) %>%
#   arrange(Species, n_sites) %>%
#   filter(n_sites == 2) %>%
#   left_join(site_pop %>%
#               select(Species, TRT, SiteID:SiteName) %>%
#               distinct()) %>%
#   as.data.frame()
```


# Methods

First, we wanted to leverage results based on empirical data from the inception of the PIT tagging program at LGR (2010) to the present. We started by gathering data on all estimates that have been made for population abundance at the TRT spacial scale, and examining the relationship between the number of tags observed in each population, and the coefficient (CV) of the estimate. We fit a model on the log scale:

$$
\text{CV} \sim \exp(a + b * n_{tags})
$$
and, in addition, a more flexible version using a loess spline. We were interested in how many tags would need to be detected within each TRT population, and using each model, to predict a CV of $\leq$ 0.15. Similarly, we alse examined the relationship between the proportion of all tags that were deployed at LGR that were detected within each population, and the CV of the population estimate. 

The previous provides information on the number of tags, or the proportion of all deployed tags, returning to a population necessary to achieve a precise abundance estimate. We then need to determine how many tags would need to be deployed at LGR to achieve that minimum number of tags to each TRT population to achieve that level of precision in our abundance estimates. To do this, we started by looking at the proportion of tags deployed at LGR that were detected in each TRT population by year, and then averaged across years. Finally, given the minimum number of detections required to achieve a precise abundance estimate, we estimated the number of total tags needed to be deployed at LGR that would be expected to result in the minimum number of detections for that TRT population. We can also predict for a given number of tags deployed at LGR whether there will be sufficient detections in each TRT population to achieve a reasonably precise abundance estimate.

```{r}
# the number of tags deployed by species and year at LGR
tags_deploy = crossing(Species = c('Chinook', 'Steelhead'),
                       spawn_yr = c(2010:2019)) %>%
  filter(!(Species == 'Chinook' & spawn_yr == 2019)) %>%
  mutate(tot_tags = map2_int(.x = Species,
                             .y = spawn_yr,
                             .f = function(x, y) {
                               load(paste0('../../SnakeBasinFishStatus/DABOM_results/LGR_DABOM_',x,'_',y,'.rda'))
                               return(nrow(proc_list$ValidTrapData))
                             }))

# proportion of all tags seen in one of the TRT populations
prop_det_df = tags_deploy %>%
              left_join(pop_est %>%
                          group_by(spawn_yr, Species) %>%
                          summarise(tot_tags_det = sum(n_tags)) %>%
                          ungroup() %>%
                          mutate_at(vars(spawn_yr),
                                    list(~ as.integer(as.character(.))))) %>%
              mutate(prop_det = tot_tags_det / tot_tags)


min_yr = 2013
min_tags = tibble(Species = c('Chinook',
                              'Steelhead'),
                  min_tags = c(50))
                  # min_tags = c(53, 45))

tags_est_df = pop_est %>%
  mutate_at(vars(spawn_yr),
            list(~ as.integer(as.character(.)))) %>%
  filter(spawn_yr >= min_yr) %>%
  # select(spawn_yr, Species, TRT, n_tags) %>%
  left_join(tags_deploy) %>%
  mutate(prop_tags_det = n_tags / tot_tags) %>%
  group_by(Species, TRT) %>%
  summarise_at(vars(prop_tags_det),
               list(mean)) %>%
  left_join(min_tags) %>%
  mutate(tot_tags_need = min_tags / prop_tags_det)


# tags_est_df %>%
#   ggplot(aes(x = tot_tags_need)) +
#   geom_histogram(aes(fill = TRT),
#                  bins = 20) +
#   geom_vline(data = tags_deploy %>%
#                filter(spawn_yr >= min_yr) %>%
#                group_by(Species) %>%
#                summarise_at(vars(tot_tags),
#                             list(mean)),
#              aes(xintercept = tot_tags),
#              linetype = 2) +
#   facet_wrap(~ Species,
#              scales = 'free') +
#   scale_fill_viridis_d()
```

```{r, eval = F}
pop_est %>%
  mutate_at(vars(spawn_yr),
            list(~ as.integer(as.character(.)))) %>%
  filter(spawn_yr >= min_yr) %>%
  select(spawn_yr, Species, TRT, n_tags) %>%
  left_join(tags_deploy) %>%
  mutate(prop_tags_det = n_tags / tot_tags) %>%
  ggplot(aes(x = spawn_yr,
             y = prop_tags_det,
             color = Species)) +
  geom_line() +
  geom_point() +
  geom_hline(yintercept = 0.01,
             linetype = 2,
             color = 'darkgray') +
  scale_color_brewer(palette = 'Set1') +
  facet_wrap(~ Species + TRT)

tags_est_df %>%
  filter(prop_tags_det < 0.01) %>%
  full_join(single_site_pops) %>%
  as.data.frame()


```

## Populations with Low Detections

When we initially examined the proportion of all tags deployed at LGR that were detected in each TRT population, by species, we noted a number of populations had very low proportions (e.g., < 2%). The low proportion of tags observed within a population can be attributed to three primary reasons:

1. True low spawner abundance.
2. Low detection probability among sites within the population.
3. Detection infrastructure within the population was not intended to monitor natural origin spawner abudance (e.g., hatchery rack detections).

In practice, detection probabilities at instream PIT tag detection systems (IPTDS) intended for natural origin population abundance monitoring have high detection probabilities, so we further examined populations with low proportions of detections and whether that was due to reasons #1 or #3 (or a combination thereof) above. In addition, the proportion of detections within a population was averaged across years, and thus, we considered populations where infrastructure was installed in a later year. `r tab_nums('remove_tab', display = 'c')` and the following narrative provide a summary of populations and years we chose to remove from the analysis due to non-existent IPTDS or infrastructure not intended for natural population monitoring. We additionally note some populations with low proportions of detections that we believe to be due to low population size.

`r tab_nums('remove_tab')`
```{r}
remove_t = read_excel('../data/TRT_Pop_Considerations.xlsx') %>%
  select(-Notes)
pander(remove_t)

rmv = remove_t %>%
  select(-SiteIDs) %>%
  gather(key, value, `2013`:`2019`) %>%
  filter(value == 'Y') %>%
  rename(spawn_yr = key,
         remove = value)
```  

### Chinook

* CRLOC: LRL installed October 2016. LRU installed December 2017.
* CRLOL: Not removed from analysis. Poor precision may be due to small population size.
* GRCAT: CCW installed in March 2015.
* GRLOO: Only includes natural origin adults that return to the Lookingglass Hatchery (LOOKGC).
* GRUMA: UGS site installed in November 2017. Complete data only for 2018. 
* GRWEN: Tandem array was installed in 2018, but blew out soon after. Re-installed in 2019. No long term data.
* IRBSH: Not removed from analysis. Poor precision may be due to small population size.
* SEMEA: SW1 installed December 2016. SW2 installed September 2017.
* SNTUC: Population occurs below LGR.
* SREFS: Array installed in 2016, but blown out soon after and not re-installed.
* SRLSR: Only includes natural origin adults that return to the Rapid River Hatchery weir (RAPH).
* SRNFS: Installed in 2016, but perfomed poorly initially. System upgraded in 2018.
* SRPAH: Only includes natural adults that return to the Pahsimeroi Hatchery weir (PAHH).
* SRPAN: Site installed in July 2017.
* SRYFS: Not removed from analysis. Poor precision may be due to small population size.

Also note that the GRLOS, GRMIN, GRCAT, and GRUMA Chinook salmon TRT populations all occur above the UGR array; however, we don't know which population an adult is destined for after passing UGR unless it is detected again upstream. As a result, Chinook salmon adults that are last observed at the UGR site cannot be used in population abundance estimates. One might consider how final observations at UGR could be leveraged in the future for upriver abundance estimates.

### Steelhead

* CRLOC-s: LRL installed October 2016. LRU installed December 2017. Remaining abundance estimates from FISTRP.
* CRSEL-s: SW1 installed December 2016. SW2 installed September 2017.
* SFSEC-s: Not removed from analysis. Believe poor precision is due to low population size.
* SNTUC-s: Population occurs below LGR.
* SREFS-s: Array installed in 2016, but blown out soon after and not re-installed.
* SRLSR-s: Only includes ad-intact adults that return to the Rapid River Hatchery weir (RAPH).
* SRNFS-s: Installed in 2016, but perfomed poorly initially. System upgraded in 2018.
* SRPAH-s: Only includes ad-intact adults that return to the Pahsimeroi Hatchery weir (PAHH).
* SRUMA-s: Not removed from analysis. Believe poor precision is due to low population size.

\newpage

# Results

## Number of Tags Required in a TRT Population

`r fig_nums('n_tags_vs_cv_fig', display = 'c')` shows the number of PIT tags detected within a TRT population and the corresponding CV of the population abundance estimate, by species, using results going back to 2013 and after removing population and year combinations in which low/no observations were due to lack of IPTDS or IPTDS not intended for natural origin population abundance.

```{r n_tags_vs_cv_fig, fig.cap = n_tags_vs_cv_fig}
pop_est = pop_est %>%
  left_join(rmv) %>%
  filter(is.na(remove)) %>%
  select(-remove)

pop_est %>%
  ggplot(aes(x = n_tags,
             y = cv)) +
  geom_point() +
  scale_color_brewer(palette = 'Set1') + 
  geom_hline(yintercept = 0.15,
             linetype = 2) +
  geom_smooth(aes(color = 'Loess'),
              span = 0.9,
              se = F,
              fullrange = T) +
  geom_smooth(aes(color = 'GLM'),
              method = glm,
              method.args = list(family = gaussian(link = "log")),
              se = F,
              fullrange = T) +
  facet_wrap(~ Species) +
  labs(x = '# PIT Tags Detected',
       y = 'CV of Pop. Est.',
       color = 'Model')
```

Additionally, using the same data, we examined the proportion of total tags deployed at LGR that were observed within a TRT population and the CV of the abundance estimate (`r fig_nums('perc_tags_vs_cv_fig', display = 'c')`).

```{r perc_tags_vs_cv_fig, fig.cap = perc_tags_vs_cv_fig}
pop_est %>%
  mutate_at(vars(spawn_yr),
            list(~ as.integer(as.character(.)))) %>%
  left_join(tags_deploy) %>%
  ggplot(aes(x = n_tags / tot_tags,
             y = cv)) +
  geom_point() +
  scale_color_brewer(palette = 'Set1') + 
  geom_hline(yintercept = 0.15,
             linetype = 2) +
  geom_smooth(aes(color = 'Loess'),
              span = 0.9,
              se = F,
              fullrange = T) +
  geom_smooth(aes(color = 'GLM'),
              method = glm,
              method.args = list(family = gaussian(link = "log")),
              se = F,
              fullrange = T) +
  facet_wrap(~ Species) +
  labs(x = '% PIT Tags Detected',
       y = 'CV of Pop. Est.',
       color = 'Model')
```

Ultimately, we were interested in the number of PIT tags that need to be observed within a population or the proportion of total PIT tags deployed at LGR detected within a population necessary to achieve a predicted CV of $\leq$ 0.15 for the abundance estimate. To do this, we tried fitting a separate model for each species, and after fitting those models (GLM and Loess), we examined the minimum number and proportion of total tags that would need to be detected to achieve that CV level. Those results are shown in `r tab_nums('n_tags_tab', display = 'c')` and `r tab_nums('prop_tags_tab', display = 'c')` below.

`r tab_nums('n_tags_tab')`
```{r}
mod_df = pop_est %>%
  group_by(Species) %>%
  nest() %>%
  mutate(mod_glm = map(data,
                      .f = function(x) {
                        glm(cv ~ n_tags,
                            family = gaussian(link = 'log'),
                            data = x)
                      }),
         mod_loess = map(data,
                         .f = function(x) {
                           loess(cv ~ n_tags,
                                 data = x)
                         }))

mod_df %>%
  gather(model, mod_fit, starts_with('mod')) %>%
  mutate(pred = map(.x = mod_fit,
                    .f = function(x) {
                      tibble(n_tags = seq(0, 300)) %>%
                        mutate(pred_cv = predict(x, 
                                                 newdata = .,
                                                 type = 'response'))
                      })) %>%
  select(Species, 
         Model = model, pred) %>%
  mutate(Model = recode(Model,
                        'mod_glm' = 'GLM',
                        'mod_loess' = 'Loess')) %>%
  unnest(cols = c(pred)) %>%
  group_by(Species, Model) %>%
  filter(pred_cv <= 0.15) %>%
  slice(1) %>%
  pander()

```  

`r tab_nums('prop_tags_tab')`
```{r}
prop_mod_df = pop_est %>%
  mutate_at(vars(spawn_yr),
            list(~ as.integer(as.character(.)))) %>%
  left_join(tags_deploy) %>%
  mutate(prop_tags = n_tags / tot_tags) %>%
  group_by(Species) %>%
  nest() %>%
  mutate(mod_glm = map(data,
                      .f = function(x) {
                        glm(cv ~ prop_tags,
                            family = gaussian(link = 'log'),
                            data = x)
                      }),
         mod_loess = map(data,
                         .f = function(x) {
                           loess(cv ~ prop_tags,
                                 data = x)
                         }))

prop_mod_df %>%
  gather(model, mod_fit, starts_with('mod')) %>%
  mutate(pred = map(.x = mod_fit,
                    .f = function(x) {
                      tibble(prop_tags = seq(0, 0.5, by = 0.001)) %>%
                        mutate(pred_cv = predict(x, 
                                                 newdata = .,
                                                 type = 'response'))
                      })) %>%
  select(Species, 
         Model = model, pred) %>%
  mutate(Model = recode(Model,
                        'mod_glm' = 'GLM',
                        'mod_loess' = 'Loess')) %>%
  unnest(cols = c(pred)) %>%
  group_by(Species, Model) %>%
  filter(pred_cv <= 0.15) %>%
  slice(1) %>%
  pander()

```  

`r tab_nums('n_tags_tab', display = 'c')` shows that we need to detect about 55 Chinook salmon and 40-46 steelhead to achieve a CV of 15% or less for natural origin abundance estimates. Further, `r tab_nums('n_tags_tab', display = 'c')` shows that, using past results, we need to detect about 3% of Chinook salmon or slight greater than 1% of steelhead PIT tags deployed at LGR to achieve reasonable precise estimates of abundance. For the sake of simplicity, let's assume that we need to detect 50 PIT tags within a population, for both species, to achieve a precise abundance estimate `r fig_nums('tag50_fig', display = 'c')`.

```{r, eval = T, fig.cap = tag50_fig}
pop_est %>%
  ggplot(aes(x = n_tags,
             y = mean)) +
  geom_point(aes(color = cv <= 0.15)) +
  scale_color_brewer(palette = 'Set1') + 
  facet_wrap(~ Species) +
  geom_vline(xintercept = c(50),
             linetype = 2) +
  labs(x = '# PIT Tags Detected',
       y = 'Pop. Est.',
       color = 'Acceptable\nPrecision')
```

### Sex and Age Estimates

We want to note that reasonably precise estimates of abundance, by sex and total age, are also a desired outcome as they are necessary to construct brood tables and estimate population productivity. However, note that it will not require 50 female tags detected within a population to achieve reasonable precision of female abundance. Rather, we will take the total abundance estimate to a TRT population and multiply it by a binomial (female vs. male) proportion to generate abundance by females and males. The binomial proportions will be estimated from all of the tags detected in that TRT population. If we have about 50 total tags detected in a populaion for a good abundance estimate, the proportion female or male will be fairly precise because 50 is a good sample size for proportions, especially when the proportion is somewhere near 50%. Therefore, the CV for the number of females in that population will be slightly larger than the CV of the total abundance, but probably not by much. 

Similar arguments hold for abundance by total age (multinomial proportions), although as we attempt to account for more age classses, the precision will suffer. Therefore, for a Chinook salmon population with 3 total age classes, we expect to get reasonable estimates with a sample size close to 50. However, for a steelhead population with up to 6 or so total age classes, the precision will suffer, especially since some of the total age classes may have very few fish.

## Total Tags at Lower Granite

We now have an estimate of the number of PIT tags that need to be detected within a TRT population (50) to achieve an abundance estimate with reasonable precision. But now we want to know how many PIT tags would need to be deployed at LGR to observe 50 PIT tags within any population. The proportion of tags detected in any TRT population has changed over time, due to more IPTDS infrastructure being installed `r fig_nums('prop_tags_lgr_fig', display = 'c')`, and thus, we chose to focus on the period from `r min_yr` on, since the infrastructure has been more stable since then. Since `r min_yr`, the average proportion of all tags deployed from LGR that were detected in a TRT population, by species, is shown in `r tab_nums('prop_det_tab', display = 'c')`.

```{r prop_black_box, fig.cap = prop_tags_lgr_fig}
prop_det_df %>%
  ggplot(aes(x = spawn_yr,
             y = prop_det,
             color = Species)) +
  geom_line() +
  geom_point() +
  scale_color_brewer(palette = 'Set1') +
  scale_x_continuous(breaks = pretty_breaks()) +
  labs(x = 'Spawn Year',
       y = 'Proportion Tags Detected after LGR',
       color = 'Species')
```

`r tab_nums('prop_det_tab')`
```{r}
prop_det_df %>%
              filter(spawn_yr >= min_yr) %>%
              group_by(Species) %>%
              summarise_at(vars(prop_det),
                           list(mean)) %>%
  clean_names(case = 'upper_camel') %>%
  pander()
```

Next, `r tab_nums('lgr_tags_needed', display = 'c')` summarizes the total number of tags that would need to be deployed at LGR to achieve a precise abundance estimate for any given population. 

`r tab_nums('lgr_tags_needed')`
```{r}
# This is ugly and brute force, but I can fix later using remove_t
rmv_trt = data.frame(Species = c(rep('Chinook', 12), rep('Steelhead', 7)),
                     TRT = c('CRLOC', 'GRCAT', 'GRLOO', 'GRUMA', 'GRWEN', 'SEMEA', 'SNTUC',
                             'SREFS', 'SRLSR', 'SRNFS', 'SRPAH', 'SRPAN', 'CRLOC-s',
                             'CRSEL-s', 'SNTUC-s', 'SREFS-s', 'SRLSR-s', 'SRNFS-s', 'SRPAH-s'),
                     Remove = rep('Yes', 19))

tags_tables = tags_est_df %>%
  left_join(site_pop %>%
              select(Species, TRT, Name = POP_NAME) %>%
              distinct()) %>%
  select(Species, TRT, Name, everything()) %>%
  left_join(rmv_trt) %>%
  filter(is.na(Remove)) %>%
  select(-Remove) %>%
  arrange(Species, desc(tot_tags_need)) %>%
  split(list(.$Species))

tags_tables[[1]] %>%
  pander(round = 3)

tags_tables[[2]] %>%
  pander(round = 3)
```

Finally, we summarised these results by examining what percentage of the TRT population abundance estimates we would expect to be reasonably precise (i.e. CV $\leq$ 0.15) given a certain number of tags deployed at Lower Granite (`r fig_nums('perc_good_cv', display = 'c')`). Results were similar for each species. As an example, if 2,000 PIT tags were deployed for each species at LGR, we might expect that approximately 40% of TRT population abundance estimates would have a CV of 15% or less; with 4,000 PIT tags per species, we'd expect that about 62-75% of population abundance estimates would be reasonably precise.

```{r perc_good_CV, fig.cap = perc_good_cv}

tags_est_df %>%
  select(Species, TRT, tot_tags_need) %>%
  left_join(rmv_trt) %>%
  filter(is.na(Remove)) %>%
  crossing(tot_tags_deploy = seq(500, 8000, by = 100)) %>%
  mutate(sufficient = if_else(tot_tags_deploy >= tot_tags_need,
                              T, F)) %>%
  group_by(Species, tot_tags_deploy) %>%
  summarise(n_TRT_suff = sum(sufficient),
            n_TRT_not_suff = sum(!sufficient),
            n_TRT_tot = n_TRT_suff + n_TRT_not_suff) %>%
  ggplot(aes(x = tot_tags_deploy,
             y = n_TRT_suff / n_TRT_tot,
             color = Species)) +
  geom_line() +
  geom_point() +
  scale_color_brewer(palette = 'Set1') +
  labs(x = '# Tags Deployed at Lower Granite',
       y = expression(paste("Proportion of TRT Populations with Precise ", hat(N))))
```

# Conclusions

These results suggest we need to detect a minimum of about 50 tags per TRT population to achieve acceptable precision in our abundance estimates at the TRT spatial scale. 

## Next Steps

1. Translate the number of total tags into a tagging rate, depending on total run size at Lower Granite.
2. Do we need to add evaluation on how multiplying abundance by sex and age proportions may affect precision of those estimates?

