---
title: "Hatchery Tagging to Estimate pHOS Using IPTDS Detections"
author:
- Kevin See:
    correspondence: yes
    email: Kevin.See@biomark.com
    institute: biomark
- Mike Ackerman:
    correspondence: yes
    email: Mike.Ackerman@biomark.com
    institute: biomark
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  html_document:
    fig_height: 6
    fig_width: 8
    pandoc_args:
    - --lua-filter=../templates/scholarly-metadata.lua
    - --lua-filter=../templates/author-info-blocks.lua
    - --lua-filter=../templates/pagebreak.lua
    theme: simplex
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: 3
    pandoc_args:
    - --lua-filter=../templates/scholarly-metadata.lua
    - --lua-filter=../templates/author-info-blocks.lua
    - --lua-filter=../templates/pagebreak.lua
institute:
- biomark: Biomark, Inc.
csl: ../templates/american-fisheries-society.csl
---

```{r setUp, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
library(knitr)
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)

library(captioner)
tab_nums = captioner(prefix = 'Table')
fig_nums = captioner()

library(pander)
# options for table formatting
panderOptions('big.mark', ',')
panderOptions('keep.trailing.zeros', FALSE)
panderOptions('table.split.table', Inf)

# load necessary packages
library(tidyverse)
library(janitor)
library(lubridate)
library(readxl)
```

# Introduction

The Dam Adult Branch Occupancy Model (DABOM) is currently used to estimate adult escapement of natural origin spring/summer Chinook salmon *Onchorhynchus tshawytscha* and steelhead *O. mykiss* into watersheds and populations of the Snake River Basin (SRB). Escapement estimates are made based on the tagging of a random sample of adults at Lower Granite Dam (LGR) and the subsequent detection of those adults at instream PIT tag detection systems (IPTDS) throughout the SRB. DABOM could also be used to generate estimates of hatchery escapement to various locations as well, which would be useful for estimating hatchery abundance in natural areas and the proportion of hatchery origin spawners (*pHOS*). Doing so, with reasonable precision, may require a random sample (or similar) of adult hatchery fish also be PIT tagged at LGR. Here, we wish to determine expected levels of precision for *pHOS* given current levels of PIT tagging in the SRB, and further, determine the additional tagging, expressed as a tagging rate or number of tags, required in hatchery adults at LGR to achieve unbiased estimates of hatchery escapement and *pHOS* with reasonable levels of precision (e.g., coefficient of variaion [CV] of $\leq$ 15%).

Simultaneously estimating escapement of hatchery origin (HOR) and natural origin (NOR) adults to IPTDS locations throughout the SRB based on PIT tagging at LGR is a trivial extension of the DABOM model. Factually, the previous and existing instance of the DABOM model was developed for the upper Columbia River (upstream of Priest Rapids Dam), which capitalized on the same sampling assumptions applied to natural origin escapement past LGR. However, for multiple reasons (ergonomic limitations at LGR, political considerations, supposed ethical concerns), the random sampling and PIT tagging of HOR adults (specifically ad-clipped adults) at LGR has been precluded. Notably, given trap operations at LGR, HOR adults are trapped, anesthetized, weighed, and measured at the same rate as NOR - a function of "trap rate" constituting a fraction of every hour wherein adults in the ladder are bypassed to the trap. Thus, it is arguable that implantation of a PIT tag constitutes a significantly greater offense to captured hatchery adults.

Importantly, NOR and HOR refer to the origin of a Chinook salmon or steelhead that is born in the natural or hatchery environment, respectively. Related, three phenotypic origins of adult Chinook salmon and steelhead are identified at LGR and include wild (W), hatchery ad-intact (HNC), and hatchery ad-clipped (H). NOR includes only W adults whereas HOR includes both the HNC and H groups despite HNC individuals often being phenotypically W. Currently, all ad-intact fish are systematically PIT tagged at LGR which includes both the W and HNC origins i.e., some HOR adults are currently tagged at LGR, but we need to consider differential tagging rates between HNC and H adults when evaluating the precision of *pHOS* given current levels of PIT tagging.

Unbeknownst to the proposal for this evaluation, a condition of the Hatchery and Genetics Management Plan (HGMP) required the operation of IDFG HOR steelhead production to conduct a study on HOR contributions to NOR populations. Thusly, IDFG and NOAA Fisheries endeavored to compile and estimate straying of HOR steelhead upstream of LGR.

This document seeks to begin collaboration between IDFG, NOAA Fisheries, and Biomark, Inc. to:

* Capitalize on existing progress on stray rates, and
* Advance statistical modeling to determine whether *pHOS* estimates can be reliablly prosecuted by adult HOR PIT tagging at LGR.

In its developed form, the DABOM model includes escapement for NOR and HOR adult salmonids. Demonstrably, the DABOM is fully functional for multiple populations of spring/summer Chinook salmon and steelhead upstream of LGR. The performance of DABOM in the upper Columbia River (above Priest Rapids Dam) strongly suggests that the model can be reliably extended to HOR. Contents of this document, including findings, will be reported as part of a Final (Annual) Progress Report for Bonneville Power Administration (BPA) project 2019-006-00.

## Objectives

This assessment aims to determine the number or tagging rate of HOR adults at LGR necessary to determine *pHOS* across watersheds or populations of SRB steelhead estimated by the DABOM model (and supported by the operation of IPTDS maintained and operated under BPA project 2018-002-00) and with "reasonable" uncertainty (e.g., CV $\leq$ 15%). As a natural extension, we may also explore additional effort necessary to estimate *pHOS* in watersheds or populations of interest for Chinook salmon. Our objectives are as follows:

1. Determined expected CVs for current estimates of *pHOS* that could be generated for locations or populations in the SRB given current levels of PIT tagging. Current tagging includes:
  + 1A. Individuals tagged within hatchery smolt releases, and
  + 1B. Ad-intact hatchery (HNC) adults that are systematically PIT tagged at LGR to evaluate abundance and composition at LGR (e.g., Camacho et al. 2017) and at IPTDS (e.g., Orme and Kinzer 2018).
2. Determine additional tagging at LGR of adult HOR fish that would allow reasonable estimates of *pHOS*. 

We will define reasonable as an estimate with a CV of 15% or less. Our evaluation may (or may not) attempt to focus on desired or critical populations/locations.

```{r captions}
# lgr_tags_needed = tab_nums('lgr_tags_needed',
#                            'The expected number of tags needed to be deployed at LGR to achieve a minimum number of detections in each TRT population leading to reasonably precise estimate of abundance.')

site_table = tab_nums('site_table',
                      'Steelhead TRT populations and interrogation sites for which we queried interrogation of hatchery adults during spawn years 2017-2019.')

obs_summary = tab_nums('obs_summary',
                       'The number of observations of adult hatchery steelhead by location, spawn year, and mark site.')

juv_phos = tab_nums('juv_phos',
                    'Hatchery, wild, and total abundance estimates and associated pHOS estimates for location x spawn year combinations with hatchery observations from smolt releases in the Snake River Basin.')

tradeoff_fig = fig_nums('tradeoff_fig',
                        "Predictions of the CV of pHOS across ranges of the CV hatchery and wild escapement estimates and the proportion wild (inverse of pHOS). The horizontal dotted line depicts a CV of 15%.")
```

# Methods

### Section 1A. Expected precision of *pHOS* given current PIT tagging of hatchery smolt releases

Here, our aim is to evaluate the expected precision (CV) of *pHOS* using observations of individuals tagged within hatchery smolt releases and expansion values (inverse of tagging fraction) for those releases. 

$$
\hat{N_{h}} = \sum_{r=1}^{n}{n_r} * {\psi_{r}}
$$
where $\hat{N_{h}}$ is the HOR abundance, $n_r$ is the number of observations of HOR individuals from release $r$ and $\psi_r$ is the expansion value for release $r$. HOR escapement to a given location can then be combined with estimates for NOR escapement from DABOM to estimate *pHOS* with uncertainty.

$$
p_{HOS} = \frac{\hat{N_h}}{\hat{N_h} + \hat{N_n}}
$$
where $\hat{N_{h}}$ is the NOR abundance. Importantly, DABOM requires a random sample of tagged individuals (e.g., at the adult trap), and thus, we cannot generate at hatchery abundance estimate in the DABOM model using juvenile tagging; hence, the tag expansion approach. 

**Kevin - I realized here that we didn't account for detection probability. But it's unclear to me how we would easily account for detection probability given that there can be numerous sites within a group. Wouldn't we have to, for each observation, take the expansion value for a fish and divide it by the estimated detection probability of the observation location and year from DABOM?**

In other words, we need to expand the number of hatchery observations from each release group by the tagging fraction  for that release groups and then sum across groups, and further, account for the detection probability of IPTDS sites within a location. Note that in this scenario we don't need to account for differential survival among groups; we are only interested in tagging fractions within groups as long as we are willing to assume equal survival between tagged and untagged smolts.

#### Approach

The IDFG provided us with tagging fraction (i.e., expansion factor) information by brood year (BY), rearing hatchery, and mark type (H vs. HNC) for steelhead hatchery releases within Idaho from BY2013-2018. In addition, we have interrogation data and abundance estimates for wild steelhead populations available through spawn year (SY) 2019. Hatchery steelhead in Idaho are always released and emigrate to the ocean as 1 year olds. Using SY2019 hatchery adults as an example, those adults would have entered the Columbia River to initiate their spawning run during summer 2018; and thus 1-ocean adults would have emigrated to the ocen in 2017 (hence BY2016) and 2-ocean adults would have emigrated in 2016 (BY2015). Following this logic, we can consider the following BY smolt releases for each adult SY:

* SY2019: 1-ocean = BY2016, 2-ocean = BY2015
* SY2018: 1-ocean = BY2015, 2-ocean = BY2014
* SY2017: 1-ocean = BY2014, 2-ocean = BY2013

And thus, the earliest SY we can consider is 2017 as their 2-ocean adults originate from BY2013.

```{r tag_deploy}
min_yr = 2013
min_tags = 50

# the number of tags deployed by species and year at LGR
tags_deploy = crossing(Species = 'Steelhead',
                       spawn_yr = c(2010:2019)) %>%
  mutate(tot_tags = map2_int(.x = Species,
                             .y = spawn_yr,
                             .f = function(x, y) {
                               load(paste0('../../SnakeBasinFishStatus/DABOM_results/LGR_DABOM_Steelhead_', y , '.rda'))
                               return(nrow(proc_list$ValidTrapData))
                             }))
```

##### Locations

A recent assessment by See et al. (2019) identified TRT steelhead populations or locations containing IPTDS that can be used to estimate wild population abundance. We then performed a PTAGIS query for locations evaluated there, and in addition, queried for hatchery adult observations in the Lochsa, Selway, and North Fork Salmon rivers from smolt releases. `r tab_nums('site_table', display = 'c')` summarizes TRT populations and iterrogation sites for which we queried observations of hatchery adults during SY2017-2019. The following constraints were placed on our PTAGIS query:

* Species: Steelhead
* Rear: Hatchery
* Last Obs Date/Time: 07/01/2017 - 06/30/2019
* Obs Site: in `r tab_nums('site_table', display = 'c')`

<center>
```{r sthd_ests}
AbundanceFolder = '../../SnakeBasinFishStatus/Abundance_results' # for processed files
# wild steelhead abundance estimates
sthd_est = read_excel(paste0(AbundanceFolder, '/LGR_AllSummaries_Steelhead.xlsx'), sheet = 2) %>%
  filter(!is.na(n_tags)) %>%
  mutate_at(vars(spawn_yr:TRT),
            list(as.factor)) %>%
  mutate(cv = as.numeric(cv)) %>%
  mutate(spawn_yr = as.integer(as.character(spawn_yr))) %>%
  filter(spawn_yr >= min_yr) %>%
  left_join(tags_deploy) %>%
  mutate(prop_tags_det = n_tags / tot_tags) %>%
  group_by(Species, TRT) %>%
  summarise_at(vars(prop_tags_det),
               list(mean)) %>%
  mutate(min_tags = min_tags) %>%
  mutate(tot_tags_need = min_tags / prop_tags_det) %>%
  arrange(-tot_tags_need)

# which sites are attached to which TRT populations?
sthd_pop = read_csv('../data/Site_TRT_Steelhead.csv')
rmv_pops = c('SRLSR-s', 'SREFS-s', 'SRPAH-s', 'SNTUC-s')

sthd_est = sthd_est %>%
  left_join(sthd_pop %>%
              select(TRT, Name = POP_NAME) %>%
              distinct()) %>%
  select(Species, TRT, Name, everything()) %>%
  filter(!TRT %in% rmv_pops)

# sthd_est %>%
#   rename(`% Tags Detected` = prop_tags_det,
#          `Min. # Tags` = min_tags,
#          `Total Tags Needed` = tot_tags_need) %>%
#   pander(round = 3)
```
</center>

`r tab_nums('site_table')`
<center>
```{r site_ids}
trts = pull(sthd_est, TRT)

sites = sthd_pop %>%
  select(TRT, SiteID) %>%
  filter(TRT %in% trts) %>%
  distinct() %>%
  mutate(site_char = nchar(SiteID)) %>%
  filter(site_char == 3) %>%
  select(-site_char)

site_table = sites %>%
  group_by(TRT) %>%
  summarise(toString(SiteID)) %>%
  ungroup() %>%
  arrange(TRT) %>%
  rename(SiteID = `toString(SiteID)`)

site_table %>%
  left_join(sthd_est %>%
              ungroup() %>%
              select(TRT, Name) %>%
              distinct()) %>%
  select(TRT, Name, SiteID) %>%
  pander()

# pander(site_table)
```
</center>

<!---
We have smolt marking information for brood years (BY) 2013-2018. BY2013 smolts would be released in spring 2014, emigrate and rear in the ocean for 1 ('A-run') or 2 ('B-run') years and enter the Columbia again in 2015 or 2016 to spawn in spring 2016 or 2017. As a result, we will limit our PTAGIS query to spawn years 2016 to 2019, the years for which we have PIT tag marking fraction information for smolt releases. 
-->

```{r filter_sites}
snake_hatcheries = c("CLWH", "DWOR", "HAGE", "MAVA", "NISP")

sthd_obs = read_csv('../data/PTAGIS/pHOS_IntSumm_Sthd_SY16-19.csv') %>%
  clean_names(case = 'snake') %>%
  filter(mark_site_code_value %in% snake_hatcheries) %>%
  mutate_at(vars(ends_with('time_value')),
            list(mdy_hm)) %>%
  mutate(mark_date_mmddyyyy = as.Date(mark_date_mmddyyyy, format = "%m/%d/%Y")) %>%
  mutate(mark_month = month(mark_date_mmddyyyy)) %>%
  mutate(brood_yr = year(mark_date_mmddyyyy),
         brood_yr = if_else(mark_month < 5,
                            mark_year_yyyy - 1,
                            mark_year_yyyy)) %>%
  # filter out marks previous to 2013
  filter(mark_year_yyyy >= 2013) %>%
  # filter out any detection when last_time_value is < 1 yr from mark_year_yyyy; presumable juvenile interrogations
  filter(year(last_time_value) - mark_year_yyyy > 1) %>%
  # if last observation is in July or later, assign fish to next spawn year
  mutate(spawn_yr = year(last_time_value),
         spawn_yr = if_else(month(last_time_value) >= 7,
                            spawn_yr + 1,
                            spawn_yr)) %>%
  left_join(sites, by = c("site_code_value" = "SiteID")) %>%
  # finally, the diff between spawn_yr and brood_yr should always be 3 or 4
  mutate(brood_to_spawn = spawn_yr - brood_yr) %>%
  filter(brood_to_spawn %in% c(3,4)) %>%
  select(-brood_to_spawn)

write_csv(sthd_obs, "../data/PTAGIS/pHOS_IntSumm_Sthd_SY16-19_filtered.csv")
```

```{r read_in_data, eval = F}
sc_sthd = read_csv('../data/PTAGIS/pHOS_IntSumm_Sthd_SC_2016-2019.csv') %>%
  clean_names(case = 'snake') %>%
  mutate_at(vars(ends_with('time_value')),
            list(mdy_hms)) %>%
  mutate(spawn_yr = year(last_time_value),
         spawn_yr = if_else(month(last_time_value) >= 7,
                            spawn_yr + 1,
                            spawn_yr)) %>%
  # filter out most recent spawn year, and any detections when last_time_value is < 1 year from mark year
  filter(spawn_yr < 2020) %>%
  filter(year(last_time_value) - mark_year_yyyy > 1)

lem_sthd = read_csv('../data/PTAGIS/pHOS_IntSumm_Sthd_Lem_2016-2019.csv') %>%
  clean_names(case = 'snake') %>%
  mutate_at(vars(ends_with('time_value')),
            list(mdy_hms)) %>%
  mutate(spawn_yr = year(last_time_value),
         spawn_yr = if_else(month(last_time_value) >= 7,
                            spawn_yr + 1,
                            spawn_yr)) %>%
  # filter out most recent spawn year, and any detections when last_time_value is < 1 year from mark year
  filter(spawn_yr < 2020) %>%
  filter(year(last_time_value) - mark_year_yyyy > 1)
```

Next, we filtered the above results from the PTAGIS query to only include the following observations:

* Mark Site Code Value: From Snake River hatcheries for which we have tagging fraction data for BY2013-2018 (i.e., `r snake_hatcheries`).
* Mark Year: Excluded marks that occurred prior to 2013. This includes filtering "orphan" tags.
* Last Obs Time - Mark Year < 1: In many cases, the mark year was less than 1 year prior to the final IPTDS observation. These observations are presumably from hatchery smolt releases and were removed.
* Spawn Year - Brood Year = 3 or 4: Returning adult hatchery steelhead should be 3 ('A-run') or 4 ('B-run') years old. We excluded any observations where this was not the case.

And finally, for each observation, IDFG identified whether each tag was from an RAL or RTR release, and for RAL fish, the appropriate expansion value. RTR observations were ignored. Descriptions of RTR vs. RAL are as follows:

* RTR ("Return-to-River"): A sort-by-code designation for smolts that will automatically be returned to the river when detected at a dam, when other fish may be getting transported. They do not represent the release group at-large, therefore represent only themselves with an expansion value of "1".
* RAL ("Run-at-Large"): A sort-by-code designation for smolts that will be transported or returned to the river in accordance with the protocol at the dam when they are detected. They represent the release group with a tagging rate that excludes any smolts that have an RTR tag in them. The expansion value of RAL tagged fish is the inverse of the tag rate.

`r tab_nums('obs_summary', display = 'c')` shows the number of RTR observations from hatchery smolt releases by TRT population, spawn year, and rearing hatchery in our final dataset. Observations were then expanded and compared to wild spawner abundance in those locations.

`r tab_nums('obs_summary')`
<center>
```{r hatchery_observation}
final_sthd_obs = read_excel("../data/PTAGIS/pHOS_IntSumm_Sthd_SY16-19_filtered_fb.xlsx")

obs_table = final_sthd_obs %>%  
  select(tag_code:expansion_value, mark_site_code_value, brood_yr:TRT) %>%
  filter(sbycode == "RAL") %>%
  group_by(TRT, spawn_yr) %>%
  count(mark_site_code_value) %>%
  spread(key = mark_site_code_value, value = n) %>%
  ungroup() %>%
  mutate(Total = select(., CLWH:NISP) %>% rowSums(na.rm = T)) %>%
  rename(`Spawn Year` = spawn_yr)

obs_table %>%
  mutate_at(vars(`Spawn Year`),
            list(as.factor)) %>%
  pander(missing = '-')
```
</center>

### Section 1B. Expected precision of *pHOS* given current systematic PIT tagging of HNC adults at LGR

Next, we evaluated the expected precision (CV) of *pHOS* estimates given current PIT tagging rates of ad-intact adults, both wild (W) and hatchery (HNC) at LGR. This leverages the fact that all ad-intact adults trapped at LGR are already implanted with a PIT tag. Estimates of wild adult abundance across select TRT populations and locations in the SRB are already available from DABOM. Here, we will re-run DABOM for HNC individuals to get HNC abundance estimates for locations and populations where we already report W abundance using DABOM. The HNC and W abundance estimates, at the same spatial scales, can then easily be combined to estimate *pHOS* with uncertainty.

This evaluation ignores ad-clipped H adults, but is effective for estimating *pHOS* among ad-intact individuals and may be of particular interest for supplementation locations (e.g., South Fork Clearwater steelhead). Unfortunately, it seems there is no easy way to combine juvenile smolt release tagging (tag expansion approach) and adult tagging information at LGR (DABOM model, transition probability approach) to estimate hatchery abundance and *pHOS* using IPTDS observations.

### Section 2. Expected precision of *pHOS* by adding tagging of ad-clipped hatchery (H) adults at LGR

Finally, we evaluated the expected precision (CV) of *pHOS* estimates given additional (theoretical) tagging of ad-clipped hatchery (H) adults at LGR using a simulation approach. Here, again, we must ignore PIT tagged hatchery smolt releases and the tag expansion approach as the DABOM model is reliant on systematic tagging of the adult return. Our goal is to evaluate a range of tagging numbers (or rates) at LGR for H adults, estimate abundance of ad-intact (W and HNC) and ad-clipped (H) adults to a given DABOM branch, and then combine H and HNC abundance with W abundance to estimate *pHOS* with uncertainty. Again, we need to account for the fact that adult HOR fish at LGR come in two flavors: ad-intact (HNC) and ad-clipped (H). Currently, all ad-intact fish that are trapped (W and HNC) are PIT-tagged, assuming they weren't previously tagged. So here we will focus on ad-clipped (H) adults only. In other words, we may need to account for differential tagging rates between ad-clipped (H) and ad-intact (HNC) when estimating *pHOS* here.

#### Mathematical Reasoning

First, we demonstrate how an estimate of *pHOS* can be generated under the DABOM framework. The estimate of *pHOS* at any branch $i$ in the DABOM model can be written as

$$
\hat{pHOS_i} = \frac{\mu_{h,i}}{\mu_{h,i} + \mu_{w,i}}
$$

where $\mu_{h,i}$ and $\mu_{w,i}$ are the estimates of hatchery and wild fish who have escaped to spawn in branch $i$. Ignoring the subscript $i$, let $\sigma^2_h$ and $\sigma^2_w$ represent the variance of those estimates. Then we can re-write our equation for *pHOS* as a function of hatchery and wild escapement estimates, assuming they are independent of one another (and assuming multivariate normality):

$$
\begin{aligned}
\hat{pHOS} &= \frac{h}{h + w} = 
  g \left(
    \begin{array}{c}
      h \\ 
      w
    \end{array}
    \right) \\
\\
g \left(
  \begin{array}{c}
    h \\ 
    w
  \end{array}
  \right) &\sim N \left( 
  \begin{array}{c} 
    \mu_h \\ 
    \mu_w 
    \end{array}, 
    \left( 
    \begin{array}{cc}
      \sigma^2_h & 0 \\
      0 & \sigma^2_w
    \end{array}
      \right)  \right) \\
\\
  &\equiv N( \boldsymbol{\mu}, \Sigma)
\end{aligned}
$$

Then, via the delta method (or Taylor approximation) [@Doob1935], we can derive the variance of our estimates of *pHOS*:

$$
\begin{aligned}
Var(g) &= \left( \frac{ \partial g}{\partial h}, \frac{ \partial g}{\partial w} \right) \Sigma \left( \begin{array}{c} \frac{ \partial g}{\partial h} \\ \frac{ \partial g}{\partial w} \end{array} \right) \\
\\
&= \left( \frac{w}{(h+w)^2}, \frac{h}{(h+w)^2} \right) 
  \left( 
    \begin{array}{cc}
      \sigma^2_h & 0 \\
      0 & \sigma^2_w
    \end{array}
  \right) 
  \left( 
    \begin{array}{c}
    \frac{w}{(h+w)^2} \\
    \frac{h}{(h+w)^2}
    \end{array}
  \right)
\\
&= \left( \frac{w \sigma^2_h}{(h+w)^2}, \frac{h \sigma^2_w}{(h+w)^2} \right) 
    \left( 
    \begin{array}{c}
    \frac{w}{(h+w)^2} \\
    \frac{h}{(h+w)^2}
    \end{array}
  \right)
\\
&= \frac{w^2 \sigma^2_h + h^2 \sigma^2_w}{(h+w)^4},
\end{aligned}
$$

so the standard error of *pHOS* is

$$
SE(g) = \frac{w \sigma_h + h \sigma_w}{(h+w)^2},
$$

which implies that the CV of *pHOS* can be derived as

$$
\begin{aligned}
CV(g) &= \frac{SE(g)}{g} \\
\\
&= \frac{w \sigma_h + h \sigma_w}{(h+w)^2} * \frac{(h+w)}{h} \\
\\
&= \frac{w \sigma_h + h \sigma_w}{h(h+w)}\\
\\
&= \frac{h \sigma_w}{h(h+w)} + \frac{w \sigma_h}{h(h+w)} \\
\\
&= \frac{\sigma_w}{(h + w)} + \frac{w}{(h+w)} * \frac{\sigma_h}{h} \\
\\
&= \frac{w}{(h+w)} \left( \frac{\sigma_w}{w} + \frac{\sigma_h}{h} \right),
\end{aligned}
$$

which is a combination of the proportion of wild fish, the CV of the estimate of wild fish and the CV of the estimate of hatchery fish.

In other words, we can predict the CV of *pHOS* for a variety of situations for a given branch $i$ by varying the percent wild fish in a stream, and the precision (or CV) of our escapement estimates of wild and hatchery fish in branch $i$. We selected several levels of precision in our estimates of wild fish, with CVs from 0.01 to 0.5, and a range of precision in our hatchery estimates, with CVs from 0 to 1.5, and then calculated the predicted CV of *pHOS* on those values.

# Results

### Section 1A. Expected precision of *pHOS* given current PIT tagging of hatchery smolt releases

`r tab_nums('obs_summary', display = 'c')` summarizes hatchery, wild, and total abundance estimates and the corresponding *pHOS* estimates for locations and spawn years in which there were IPTDS observations of hatchery adults from RTR smolt releases. Wild abundance estimates are from the DABOM model whereas hatchery abundance estimates are using the expansion approach outlined above. `r tab_nums('obs_summary', display = 'c')` also includes the number of hatchery and wild tags observed and the CV (%) of the wild abundance estimates for context. Unfortunately, we are currently unable to estimate uncertainty in hatchery abundance, and thus, unable to estimate uncertainty in *pHOS* using the approach. To do so, we would have to identify and estimate sources of uncertainty in the hatchery abundance; uncertainty in the tagging fraction (i.e., expansion value) would be one example.

`r tab_nums('juv_phos')`
<center>
```{r juv_phos}
pHOS_1a = final_sthd_obs %>%
  select(tag_code:expansion_value, mark_site_code_value, brood_yr:TRT) %>%
  filter(sbycode == 'RAL') %>%
  group_by(TRT, spawn_yr, mark_site_code_value) %>%
  summarise(Abundance = round(sum(expansion_value),0)) %>%
  spread(key = mark_site_code_value, value = Abundance) %>%
  ungroup() %>%
  mutate(`Hatchery Abundance` = select(., CLWH:NISP) %>% rowSums(na.rm = T)) %>%
  rename(`Spawn Year` = spawn_yr)
    
wild_abund = read_excel(paste0(AbundanceFolder, '/LGR_AllSummaries_Steelhead.xlsx'), sheet = 2) %>%
  select(TRT, spawn_yr,
         n_wild_tags = n_tags,
         median, cv) %>%
  mutate(cv = as.numeric(cv)) %>%
  filter(median != 0) %>%
  mutate(cv = cv*100) %>%
  rename(`Wild Abundance` = median,
         `CV (%)` = cv)

pHOS_1a = obs_table %>%
  mutate_at(vars(`Spawn Year`),
            list(as.numeric)) %>%
  select(TRT, `Spawn Year`,
         n_hatch_tags = Total) %>%
  left_join(pHOS_1a) %>%
  left_join(wild_abund, by = c("TRT" = "TRT",
                               "Spawn Year" = "spawn_yr")) %>%
  mutate(`Total Abundance` = `Hatchery Abundance` + `Wild Abundance`) %>%
  mutate(pHOS = round(`Hatchery Abundance`/`Total Abundance`,3)) %>%
  rename(`n. Tags Hatchery` = n_hatch_tags,
         `n. Tags Wild` = n_wild_tags)
pHOS_1a %>%
  mutate_at(vars(`Spawn Year`),
            list(as.factor)) %>% 
  pander(missing = '-')

```
</center>

### Section 1B. Expected precision of *pHOS* given current PIT tagging of W and HNC adults at LGR

### Section 2. Expected precision of *pHOS* by adding tagging of ad-clipped hatchery (H) adults at LGR

#### Mathematical Reasoning

We predicted the CV of *pHOS* across a range of values for both hatchery escapement CV (0 - 1.5) and proportion wild (i.e., inverse of *pHOS*). The results are shown in `r fig_nums('tradeoff_fig', display = 'c')`.

```{r tradeoff_fig, fig.cap = fig_nums('tradeoff_fig')}
# proportion of wild fish in the stream
propWild = seq(0.05, 0.95, 0.05)
# CV of the estimate of wild fish
cvW = c(0.01, 0.05, 0.1, 0.15, 0.2, 0.25, 0.3, 0.4, 0.5)
# CV of the estimate of hatchery fish
cvH = seq(0, 1.5, 0.05)

crossing(propWild, cvW, cvH) %>%
  mutate(pHOS = 1 - propWild,
         CV = propWild * (cvW + cvH)) %>%
  mutate_at(vars(propWild, cvW),
            list(as.factor)) %>%
  ggplot(aes(x = cvH,
             y = CV,
             group = propWild,
             color = as.numeric(as.character(propWild)))) +
  scale_color_viridis_c(direction = -1,
                        end = 0.9,
                        option = 'C') +
  geom_line() +
  # geom_point() +
  geom_hline(yintercept = 0.15,
             linetype = 2,
             color = 'black') +
  # geom_vline(xintercept = 0.15,
  #            linetype = 2,
  #            color = 'black') +
  theme_bw() +
  theme(legend.position = 'bottom') +
  facet_wrap(~ cvW,
             ncol = 3) +
  # facet_grid(propWild ~ cvW) +
  labs(x = 'CV of Hatchery Escp.',
       y = 'CV of pHOS',
       color = '% Wild')
```

The general patterns show that as the proportion of wild fish in the stream descreases, the precision of *pHOS* improves for a given precision level of wild and hatchery escapement estimates. Also, as the precision of the wild estimates improves (i.e. smaller CV), there are more scenarios under which the precision of the *pHOS* estimate is reasonable. As a reference, the CVs of the estimates for spring/summer Chinook escapement to the Lemhi range from 0.1 to 0.25 for years 2010 - 2018. 

Another way to look at it would be to examine the maximum CV of hatchery estimates that would provide a reasonable estimate of *pHOS* for a given proportion of wild fish and precision of wild escapement. One way to visualize these results in in the plot below.

```{r}
cvThres = 0.15
crossing(propWild = seq(0, 1, 0.01), # proportion of wild fish in the stream
         # CV of the estimate of wild fish
         cvW = seq(0, 1, 0.01),
         # CV of the estimate of hatchery fish
         cvH = seq(0, 1.5, 0.03)) %>%
  mutate(pHOS = 1 - propWild,
         CV = propWild * (cvW + cvH)) %>%
  group_by(propWild, cvW) %>%
  summarise(nTot = n(),
            nPrec = sum(CV <= cvThres),
            maxHcv = max(cvH[CV <= cvThres])) %>%
  ungroup() %>%
  ggplot(aes(x = cvW,
             y = propWild)) +
  geom_tile(aes(fill = maxHcv)) +
  geom_contour(aes(z = maxHcv),
               color = 'black',
               bins = 10) +
  theme_minimal() +
  geom_text(x = 0.75,
            y = 0.75,
            hjust = 'inward',
            vjust = 'inward',
            label = paste0('CV > ', cvThres, '%')) +
  scale_fill_viridis_c(na.value = 'gray90',
                       begin = 0.2) +
  labs(x = 'CV of Wild Escp.',
       y = '% Wild',
       fill = 'Max CV\nHatch Est.')

```

From this plot, it is clear that as long as the proportion of wild fish in a stream is below a certain threshold (around 10%), then regardless of the CV of wild or hatchery escapement, reasonable precision of *pHOS* will be obtained.

# Discussion

## Next Steps

* Incorporate results and implications from Craig Busack's script located in ../R/idahopit.R
    + from Lance Hebdon, August 5, 2019: I would contact Busack directly, we never saw any specific analysis only Craig's description of how low a confidence we would have given the low tag rates and detection rates at a single array in a  single year basis.  Also some of the issues we had with Craig's analysis was his assumption that straying was equal across the landscape, as opposed to straying being more likely near the release points, the effect of transportation on straying, the ability to aggregate information from multiple years to further understand patterns in straying, and a few other things that I don't have on the top of my head.
* Identify 2-3 locations of interest for each Chinook salmon and steelhead to perform evaluations
* Do we need to perform a PTAGIS query for particular locations to identify HOR observations; and can we track down release 'groups' for each observation?
    
## Assumptions and Considerations

* What are the appropriate transition probabilities for hatchery fish along model branches? Need to consider harvest of hatchery fish. Presumably transition probabilities are lower for hatchery fish (relative to natural origin fish) due to harvest.
* Do hatchery fish mimic movement of wild fish? Probably not, due to the location of origin hatcheries and releases.
* Do some branches contain 0 hatchery fish?
* Should branches further upstream of LGR automatically include lower transition probabilities due to fishing on the mainstem?
* Do we need to accomodate time-varying movement probabilities in the simulation?
* Appropriate detection probabilities for each detection node in the simulation model.
* We must assume a fraction of hatchery fish will be harvested prior to reaching tributary habitats.
* How many total hatchery fish escape past LGR? We can run STADEM to determine range of values over the last several years.
* Is 15% CV for pHOS an appropriate, or even achievable, goal?

# References

Camacho, C.A., K.K. Wright, J. Powell, W.C. Schrader, T. Copeland, M.W. Ackerman, M. Dobos, M.P. Corsi, and M.R. Campbell. 2017. Wild adult steelehad and Chinook salmon abundance and composition at Lower Granite Dam, spawn years 2009-2016. Cumulative Report 2009 through 2016. Idaho Department of Fish and Game Report 17-06.

Doob, J.L. 1935. The limiting distributions of certain statistics. The Annals of Mathematical Statistics 6:160-169.

Orme, R. and R. Kinzer. 2018. Integrated In-stream PIT Tag Detection System Operations and Maintenance; PIT Tag Based Adult Escapement Estimates for Spawn Years 2016 and 2017. Nez Perce Tribe Department of Fisheries Resource Management. Prepared for: Quantititative Consultants, Inc.

See, K., M. Ackerman, and K. Meier. 2019. Tagging Rate at Lower Granite Dam. Markdown report prepared by Biomark, Inc.

<!---

## SCRAP

But then what's the next step here? To do an empirical evaluation we would then need to do a PTAGIS query of HOR observations across SRB IPTDS and be able to 'assign' each observation back to a release 'group'. Not a trivial task. And going down this path seems to require HOR runs of DABOM. 

Maybe it makes sense to include Craig Busack's demonstration here to show that, even given high detection probabilities, it may be difficult to observe HOR fish at a given location if tagging rates and number of fish are low, which could lead to biased estimates of *pHOS* at given locations if only juvenile observations are used.

### Methods Section 3
  
Now we need to figure out, depending on results from Section #2, what level of additional tagging (number or rate) is needed for HOR adults at LGR to achieve reasonable CVs for estimates of *pHOS*. This additional tagging would likely be targeted at just ad-clipped (H) fish. In this case, we could also easily calculate the tagging fraction by species x release group x brood year for adults except in this case we can ingore both $g$ and $y$ because those should be equal across groups! i.e., because we are tagging at LGR. However, we do need to account for differential tagging fractions between H and HNC, however, HNC could be set equal to the W tagging fraction (i.e., all ad-intact fish are tagged at the same rate). The final consideration to make is whether we need a time varying component in tagging fractions for juveniles and adults. I'm thinking we make a simplifying assumption here and ignore a time-varying component for this exercise.

Here's where I need help. How do we than calculate the 'overall or global' tagging fraction for a group i.e., the tagging fraction after considering juvenile and adult tagging for a given release group? And then use that to calculate abundance for that release group? And then sum across groups? Are tagging fractions for a group a summation across life stage tagging fractions? Need to clean up some of my notation and thoughts here?

In the end, for Methods section #3, perhaps it makes most sense to ignore juvenile PIT tagging fractions and simply focus on adult tagging at LGR due to 1) low juvenile tag rates and 2) complexity of problem. 

Alternatively, to determine the appropriate level of tagging, we may examine the last several years of DABOM results and focus on the number of tags observed within a few different tributaries and the level of precision of the accompanying escapement estimates, accounting for detection probability. We could then build a relationship to predict the precision based on the number of tags detected and the detection probability. After making some assumptions about the transition probability of hatchery fish to a particular tributary, we can use the estimate of detection probability to predict the precision of the escapement estimate under a variety of tagging rates.

## Simulation Description
  
The $\hat{pHOS}$ to a given location $j$ can simply be estimated as the ratio of all hatchery fish returning to a location, divided by total (i.e., hatchery and wild) fish returning. And in the case of hatchery fish, we need to account for broodstock removal and harvest (if any).

$$
\hat{pHOS} = \frac{\hat{N}_{j,H} - (Broodstock + Harvest)}{\hat{N}_{j,W} + (\hat{N}_{j,H} - (Broodstock + Harvest))}
$$

Typically, in STADEM and DABOM we estimate weekly escapement past LGR (STADEM) and weekly movement probabilities (DABOM). However, for the purposes of this simulation, perhaps we can assume similar run timings between hatchery and wild fish and among branches. And thus, wild and hatchery abundance to a given location $j$ could be simply estimated as

$$\hat{N}_{j,H} = X_H\psi_{j,H}$$
$$\hat{N}_{j,W} = X_W\psi_{j,W}$$

where $X$ is the escapement past LGR and $\psi$ is the movement probability for hatchery ($H$) and wild ($W$) fish, respectively.

-->

