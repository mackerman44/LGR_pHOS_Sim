---
title: "Hatchery Tagging to Estimate pHOS Using IPTDS Detections"
author:
  - name: Kevin See
    affiliation: Biomark, Inc.
    email: Kevin.See@biomark.com
  - name: Mike Ackerman
    affiliation: Biomark, Inc.
    email: Mike.Ackerman@biomark.com
# - Kevin See:
#     correspondence: yes
#     email: Kevin.See@biomark.com
#     institute: biomark
# - Mike Ackerman:
#     correspondence: yes
#     email: Mike.Ackerman@biomark.com
#     institute: biomark
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  html_document:
    # pandoc_args:
    # - --lua-filter=../templates/scholarly-metadata.lua
    # - --lua-filter=../templates/author-info-blocks.lua
    # - --lua-filter=../templates/pagebreak.lua
    fig_height: 6
    fig_width: 8
    theme: simplex
    toc: yes
    toc_depth: 4
    toc_float: yes
  pdf_document:
    # pandoc_args:
    # - --lua-filter=../templates/scholarly-metadata.lua
    # - --lua-filter=../templates/author-info-blocks2.lua
    # - --lua-filter=../templates/pagebreak.lua
    toc: yes
    toc_depth: 4
    includes:
      in_header: "../templates/header_ABS.tex"
# institute:
# - biomark: Biomark, Inc.
csl: ../templates/american-fisheries-society.csl
bibliography: ../references.bib
---

```{r setUp, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
# setwd('markdown')
library(knitr)
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)
options(knitr.kable.NA = '-')
# options(knitr.table.format = "pandoc")

library(captioner)
tab_nums = captioner(prefix = 'Table')
fig_nums = captioner()

library(pander)
# options for table formatting
panderOptions('big.mark', ',')
panderOptions('keep.trailing.zeros', FALSE)
panderOptions('table.split.table', Inf)
panderOptions('missing', '-')

# load necessary packages
library(tidyverse)
library(janitor)
library(lubridate)
library(readxl)
library(ggrepel)

theme_set(theme_bw())
```

# Introduction

The Dam Adult Branch Occupancy Model (DABOM) is currently used to estimate adult escapement of natural origin spring/summer Chinook salmon *Onchorhynchus tshawytscha* and steelhead *O. mykiss* into watersheds and populations of the Snake River Basin (SRB). Escapement estimates are made based on the tagging of a random sample of adults at Lower Granite Dam (LGR) and the subsequent detection of those adults at instream PIT tag detection systems (IPTDS) throughout the SRB. DABOM could also be used to generate estimates of hatchery escapement to various locations as well, which would be useful for estimating hatchery abundance in natural areas and the proportion of hatchery origin spawners (*pHOS*). Doing so, with reasonable precision, may require a random sample (or similar) of adult hatchery fish also be PIT tagged at LGR. Here, we wish to determine expected levels of precision for *pHOS* given current levels of PIT tagging in the SRB, and further, determine the additional tagging, expressed as a tagging rate or number of tags, required in hatchery adults at LGR to achieve unbiased estimates of hatchery escapement and *pHOS* with reasonable levels of precision (e.g., coefficient of variation [CV] of $\leq$ 15%).

Simultaneously estimating escapement of hatchery origin (HOR) and natural origin (NOR) adults to IPTDS locations throughout the SRB based on PIT tagging at LGR is a trivial extension of the DABOM model. Factually, the previous and existing instance of the DABOM model was developed for the upper Columbia River (upstream of Priest Rapids Dam), which capitalized on the same sampling assumptions applied to natural origin escapement past LGR. However, for multiple reasons (ergonomic limitations at LGR, political considerations, ethical concerns), the random sampling and PIT tagging of HOR adults (specifically ad-clipped adults) at LGR has been precluded. Notably, given trap operations at LGR, HOR adults are trapped, anesthetized, weighed, and measured at the same rate as NOR - a function of "trap rate" constituting a fraction of every hour wherein adults in the ladder are bypassed to the trap. Thus, it is arguable that implantation of a PIT tag constitutes a significantly greater offense to captured hatchery adults.

Importantly, NOR and HOR refer to the origin of Chinook salmon or steelhead born in the natural or hatchery environment, respectively. Related, three phenotypic origins of adult Chinook salmon and steelhead are identified at LGR and include wild (W), hatchery ad-intact (HNC), and hatchery ad-clipped (H). NOR includes only W adults whereas HOR includes both the HNC and H groups despite HNC individuals often being phenotypically W. Currently, all ad-intact fish are systematically PIT tagged at LGR which includes both the W and HNC origins i.e., some HOR adults are currently tagged at LGR, but we need to consider differential tagging rates between HNC and H adults when evaluating the precision of *pHOS* given current levels of PIT tagging.

Unbeknownst to the proposal for this evaluation, a condition of the Hatchery and Genetics Management Plan (HGMP) required the operation of IDFG HOR steelhead production to conduct a study on HOR contributions to NOR populations. Thusly, IDFG and NOAA Fisheries endeavored to compile and estimate straying of HOR steelhead upstream of LGR.

This document seeks to begin collaboration between IDFG, NOAA Fisheries, and Biomark, Inc. to:

* Capitalize on existing progress on stray rates, and
* Advance statistical modeling to determine whether *pHOS* estimates can be reliably prosecuted by adult HOR PIT tagging at LGR.

In its developed form, the DABOM model includes escapement for NOR and HOR adult salmonids. Demonstrably, the DABOM is fully functional for multiple populations of spring/summer Chinook salmon and steelhead upstream of LGR. The performance of DABOM in the upper Columbia River (above Priest Rapids Dam) strongly suggests that the model can be reliably extended to HOR adults in the Snake River. Contents of this document, including findings, will be reported as part of a Final (Annual) Progress Report for Bonneville Power Administration (BPA) project 2019-006-00.

## Objectives

This assessment aims to determine the number or tagging rate of HOR adults at LGR necessary to determine *pHOS* across watersheds or populations of SRB steelhead estimated by the DABOM model (and supported by the operation of IPTDS maintained and operated under BPA project 2018-002-00) and with "reasonable" uncertainty (e.g., CV $\leq$ 15%). As a natural extension, we may also explore additional effort necessary to estimate *pHOS* in watersheds or populations of interest for Chinook salmon. Our objectives are as follows:

1. Determined expected CVs for current estimates of *pHOS* that could be generated for locations or populations in the SRB given current levels of PIT tagging. Current tagging includes:
  + 1A. Individuals tagged within hatchery smolt releases, and
  + 1B. Ad-intact hatchery (HNC) adults that are systematically PIT tagged at LGR to evaluate abundance and composition at LGR (e.g., @Camacho2017) and at IPTDS (e.g., @Orme2018).
2. Determine additional tagging at LGR of ad-clipped adult HOR fish that would allow reasonable estimates of *pHOS*. 

Because *pHOS* is a proportion, defined between 0 and 1, we feel CV is not the appropriate way to measure the precision. When *pHOS* is near 0 or 1, by definition the standard error of *pHOS* will be small. However, if *pHOS* is also very small, the CV will be large, since we are dividing by a small number, even if the standard error is still quite small (and therefore reasonable). Therefore, we believe a better definition of "precise estimate of pHOS" would be to define a standard error threshold, rather than a CV threshold. We explored several standard error thresholds, and believe further discussion with management agencies is warranted to settle on one.


```{r captions}
# lgr_tags_needed = tab_nums('lgr_tags_needed',
#                            'The expected number of tags needed to be deployed at LGR to achieve a minimum number of detections in each TRT population leading to reasonably precise estimate of abundance.')

site_table = tab_nums('site_table',
                      'Steelhead TRT populations and interrogation sites for which we queried interrogation of hatchery adults during spawn years 2017-2019.')

obs_summary = tab_nums('obs_summary',
                       'The number of observations of adult hatchery steelhead by location, spawn year, and mark site.')

juv_phos = tab_nums('juv_phos',
                    'Hatchery, wild, and total abundance estimates and associated pHOS estimates for location x spawn year combinations with hatchery observations from smolt releases in the Snake River Basin.')

dabom_hnc_phos = tab_nums('dabom_hnc_phos',
                          "Estimates of abundance (CV) for ad-intact steelhead including wild and hatchery (HNC), how many tags of each origin were detected,  spawn years 2017-2019 and estimates of the proportion of hatchery origin spawners (pHOS) with standard error (SE) and coefficient of variation (CV) that takes into account uncertainty in the abundance estimates. pHOS estimates do not account for ad-clipped hatchery (H) adults.")

stray_rates = tab_nums("stray_rates",
                       "The percentage of hatchery steelhead adults, tagged as juveniles, observed straying into recipient populations from all those tags passing Lower Granite Dam, summarized by release groups. Note all values in table are expressed as a percentage.")

# cv_phos_fig = fig_nums("cv_phos_fig",
#                        "The maximum CV of hatchery abundance estimates that would provide an estimate of pHOS with reasonable precision for a given proportion of wild fish (inverse pHOS) and precision of wild escapement.")

se_phos_fig = fig_nums("se_phos_fig",
                       "The maximum CV of hatchery abundance estimates that would provide an estimate of pHOS with reasonable precision (below a standard error threshold) for a given level of pHOS and precision of wild escapement.")


tags_cv_fig = fig_nums("tags_cv_fig",
                       "Number of PIT tags observed in a population plotted against the CV of the population estimate. The dashed line shows a CV of 15%, while the red line shows the fitted log-log model.")

lgr_tags_tab = tab_nums("lgr_tags_tab",
                        "All the pieces of information that lead to an estimate of how many total tags must be deployed at Lower Granite to obtain a standard error of pHOS below the set threshold for each population.")

trt_prop_fig = fig_nums("trt_prop_fig",
                        "Expected proportion of TRT populations with a reliable estimate of pHOS for a given number of PIT tags deployed at LGR, faceted by pHOS standard error thresholds. Dashed line shows 4,000 tags. Labels depict which additional TRT populations are expected to have reasonable precision of pHOS as the number of tags deployed increases.")
```

# Methods

### Section 1. Expected precision of *pHOS* given current PIT tagging of hatchery smolt releases

Here, our aim is to evaluate the expected precision (CV) of *pHOS* using observations of individuals tagged within hatchery smolt releases and expansion values (inverse of tagging fraction) for those releases. 

$$
\hat{N_{h}} = \sum_{r=1}^{n}{n_r} * {\psi_{r}}
$$
where $\hat{N_{h}}$ is the HOR abundance, $n_r$ is the number of observations of HOR individuals from release $r$ and $\psi_r$ is the expansion value for release $r$. HOR escapement to a given location can then be combined with estimates for NOR escapement from DABOM to estimate *pHOS* with uncertainty.

$$
p_{HOS} = \frac{\hat{N_h}}{\hat{N_h} + \hat{N_n}}
$$
where $\hat{N_{n}}$ is the NOR abundance. Importantly, DABOM requires a random sample of tagged individuals (e.g., at the adult trap), and thus, we cannot generate abundance estimates in the DABOM model using juvenile tagging; hence, the tag expansion approach. In other words, we need to expand the number of hatchery observations from each release group by the tagging fraction  for that release groups and then sum across groups. Note that in this scenario we don't need to account for differential survival among groups; we are only interested in tagging fractions within groups as long as we are willing to assume equal survival between tagged and untagged smolts.

<!--
Kevin - I realized here that we didn't account for detection probability. But it's unclear to me how we would easily account for detection probability given that there can be numerous sites within a group. Wouldn't we have to, for each observation, take the expansion value for a fish and divide it by the estimated detection probability of the observation location and year from DABOM?
-->

#### Approach

The IDFG provided us with tagging fraction (i.e., expansion factor) information by brood year (BY), rearing hatchery, and mark type (H vs. HNC) for steelhead hatchery releases within Idaho from BY2013-2018. In addition, we have interrogation data and abundance estimates for wild steelhead populations available through spawn year (SY) 2019. Hatchery steelhead in Idaho are always released and emigrate to the ocean as 1 year olds. Using SY2019 hatchery adults as an example, those adults would have entered the Columbia River to initiate their spawning run during summer 2018; and thus 1-ocean adults would have emigrated to the ocean in 2017 (hence BY2016) and 2-ocean adults would have emigrated in 2016 (BY2015). Following this logic, we can consider the following BY smolt releases for each adult SY:

* SY2019: 1-ocean = BY2016, 2-ocean = BY2015
* SY2018: 1-ocean = BY2015, 2-ocean = BY2014
* SY2017: 1-ocean = BY2014, 2-ocean = BY2013

And thus, the earliest SY we can consider is 2017 as their 2-ocean adults originate from BY2013.

```{r tag_deploy}
min_yr = 2013
min_tags = 50

# the number of tags deployed by species and year at LGR
tags_deploy = crossing(Species = 'Steelhead',
                       spawn_yr = c(2010:2019)) %>%
  mutate(tot_tags = map2_int(.x = Species,
                             .y = spawn_yr,
                             .f = function(x, y) {
                               load(paste0('../../SnakeBasinFishStatus/DABOM_results/LGR_DABOM_Steelhead_', y , '.rda'))
                               return(nrow(proc_list$ValidTrapData))
                             }))
```

##### Locations

A recent assessment by See et al. (2019) identified steelhead TRT populations or locations containing IPTDS that can be used to estimate wild population abundance. We then performed a PTAGIS query for locations evaluated there, and in addition, queried for hatchery adult observations in the Lochsa, Selway, and North Fork Salmon rivers (areas with particular management interest where IPTDS have recently been installed) from smolt releases. `r tab_nums('site_table', display = 'c')` summarizes TRT populations and interrogation sites for which we queried observations of hatchery adults during SY2017-2019. The following constraints were placed on our PTAGIS query:

* Species: Steelhead
* Rear: Hatchery
* Last Obs Date/Time: 07/01/2017 - 06/30/2019
* Obs Site: In `r tab_nums('site_table', display = 'c')`

```{r sthd_ests}
# wild steelhead abundance estimates
sthd_est = read_excel("../data/LGR_AllSummaries_Steelhead.xlsx",
                      sheet = 2) %>%
  filter(!is.na(n_tags)) %>%
  mutate_at(vars(spawn_yr:TRT),
            list(as.factor)) %>%
  mutate(cv = as.numeric(cv)) %>%
  mutate(spawn_yr = as.integer(as.character(spawn_yr))) %>%
  filter(spawn_yr >= min_yr) %>%
  left_join(tags_deploy) %>%
  mutate(prop_tags_det = n_tags / tot_tags) %>%
  group_by(Species, TRT) %>%
  summarise_at(vars(prop_tags_det),
               list(mean)) %>%
  mutate(min_tags = min_tags) %>%
  mutate(tot_tags_need = min_tags / prop_tags_det) %>%
  arrange(-tot_tags_need)

# which sites are attached to which TRT populations?
sthd_pop = read_csv('../data/Site_TRT_Steelhead.csv')
rmv_pops = c('SRLSR-s', 'SREFS-s', 'SRPAH-s', 'SNTUC-s')

sthd_est = sthd_est %>%
  left_join(sthd_pop %>%
              select(TRT, Name = POP_NAME) %>%
              distinct()) %>%
  select(Species, TRT, Name, everything()) %>%
  filter(!TRT %in% rmv_pops)

# sthd_est %>%
#   rename(`% Tags Detected` = prop_tags_det,
#          `Min. # Tags` = min_tags,
#          `Total Tags Needed` = tot_tags_need) %>%
#   pander(round = 3)
```

`r tab_nums('site_table')`
<!-- <center> -->
```{r site-ids}
trts = pull(sthd_est, TRT)

sites = sthd_pop %>%
  select(TRT, SiteID) %>%
  filter(TRT %in% trts) %>%
  distinct() %>%
  mutate(site_char = nchar(SiteID)) %>%
  filter(site_char == 3) %>%
  select(-site_char)

site_table = sites %>%
  group_by(TRT) %>%
  summarise(toString(SiteID)) %>%
  ungroup() %>%
  arrange(TRT) %>%
  rename(SiteID = `toString(SiteID)`)

site_table %>%
  left_join(sthd_est %>%
              ungroup() %>%
              select(TRT, Name) %>%
              distinct()) %>%
  select(TRT, Name, SiteID) %>%
  pander()
  # kable(caption = 'Steelhead TRT populations and interrogation sites for which we queried interrogation of hatchery adults during spawn years 2017-2019.',
  #       align = 'c')

```
<!-- </center> -->

<!---
We have smolt marking information for brood years (BY) 2013-2018. BY2013 smolts would be released in spring 2014, emigrate and rear in the ocean for 1 ('A-run') or 2 ('B-run') years and enter the Columbia again in 2015 or 2016 to spawn in spring 2016 or 2017. As a result, we will limit our PTAGIS query to spawn years 2016 to 2019, the years for which we have PIT tag marking fraction information for smolt releases. 
-->

```{r filter_sites}
snake_hatcheries = c("CLWH", "DWOR", "HAGE", "MAVA", "NISP")

sthd_obs = read_csv('../data/PTAGIS/pHOS_IntSumm_Sthd_SY16-19.csv') %>%
  clean_names(case = 'snake') %>%
  filter(mark_site_code_value %in% snake_hatcheries) %>%
  mutate_at(vars(ends_with('time_value')),
            list(mdy_hm)) %>%
  mutate(mark_date_mmddyyyy = as.Date(mark_date_mmddyyyy, format = "%m/%d/%Y")) %>%
  mutate(mark_month = month(mark_date_mmddyyyy)) %>%
  mutate(brood_yr = year(mark_date_mmddyyyy),
         brood_yr = if_else(mark_month < 5,
                            mark_year_yyyy - 1,
                            mark_year_yyyy)) %>%
  # filter out marks previous to 2013
  filter(mark_year_yyyy >= 2013) %>%
  # filter out any detection when last_time_value is < 1 yr from mark_year_yyyy; presumable juvenile interrogations
  filter(year(last_time_value) - mark_year_yyyy > 1) %>%
  # if last observation is in July or later, assign fish to next spawn year
  mutate(spawn_yr = year(last_time_value),
         spawn_yr = if_else(month(last_time_value) >= 7,
                            spawn_yr + 1,
                            spawn_yr)) %>%
  left_join(sites, by = c("site_code_value" = "SiteID")) %>%
  # finally, the diff between spawn_yr and brood_yr should always be 3 or 4
  mutate(brood_to_spawn = spawn_yr - brood_yr) %>%
  filter(brood_to_spawn %in% c(3,4)) %>%
  select(-brood_to_spawn)

write_csv(sthd_obs, "../data/PTAGIS/pHOS_IntSumm_Sthd_SY16-19_filtered.csv")
```

```{r read_in_data, eval = F}
sc_sthd = read_csv('../data/PTAGIS/pHOS_IntSumm_Sthd_SC_2016-2019.csv') %>%
  clean_names(case = 'snake') %>%
  mutate_at(vars(ends_with('time_value')),
            list(mdy_hms)) %>%
  mutate(spawn_yr = year(last_time_value),
         spawn_yr = if_else(month(last_time_value) >= 7,
                            spawn_yr + 1,
                            spawn_yr)) %>%
  # filter out most recent spawn year, and any detections when last_time_value is < 1 year from mark year
  filter(spawn_yr < 2020) %>%
  filter(year(last_time_value) - mark_year_yyyy > 1)

lem_sthd = read_csv('../data/PTAGIS/pHOS_IntSumm_Sthd_Lem_2016-2019.csv') %>%
  clean_names(case = 'snake') %>%
  mutate_at(vars(ends_with('time_value')),
            list(mdy_hms)) %>%
  mutate(spawn_yr = year(last_time_value),
         spawn_yr = if_else(month(last_time_value) >= 7,
                            spawn_yr + 1,
                            spawn_yr)) %>%
  # filter out most recent spawn year, and any detections when last_time_value is < 1 year from mark year
  filter(spawn_yr < 2020) %>%
  filter(year(last_time_value) - mark_year_yyyy > 1)
```

Next, we filtered the above results from the PTAGIS query to only include the following observations:

* Mark Site Code Value: From Snake River hatcheries for which we have tagging fraction data for BY2013-2018 (i.e., `r snake_hatcheries`).
* Mark Year: Excluded marks that occurred prior to 2013. This includes filtering "orphan" tags.
* Last Obs Time - Mark Year < 1: In many cases, the mark year was less than 1 year prior to the final IPTDS observation. These observations are presumably from hatchery smolt releases and were removed.
* Spawn Year - Brood Year = 3 or 4: Returning adult hatchery steelhead should be 3 ('A-run') or 4 ('B-run') years old. We excluded any observations where this was not the case.

And finally, for each observation, personnel from the IDFG identified whether each tag was from an RAL or RTR release, and for RAL fish, the appropriate expansion value. RTR observations were ignored. Descriptions of RTR vs. RAL are as follows:

* RTR ("Return-to-River"): A sort-by-code designation for smolts that will automatically be returned to the river when detected at a dam, when other fish may be getting transported. They do not represent the release group at-large, therefore represent only themselves with an expansion value of "1".
* RAL ("Run-at-Large"): A sort-by-code designation for smolts that will be transported or returned to the river in accordance with the protocol at the dam when they are detected. They represent the release group with a tagging rate that excludes any smolts that have an RTR tag in them. The expansion value of RAL tagged fish is the inverse of the tag rate.

`r tab_nums('obs_summary', display = 'c')` shows the number of RTR observations from hatchery smolt releases by TRT population, spawn year, and rearing hatchery in our final dataset. Observations were then expanded and compared to wild spawner abundance in those locations to estimate *pHOS*.

`r tab_nums('obs_summary')`
<center>
```{r hatchery_observation}
final_sthd_obs = read_excel("../data/PTAGIS/pHOS_IntSumm_Sthd_SY16-19_filtered_fb.xlsx")

obs_table = final_sthd_obs %>%  
  select(tag_code:expansion_value, mark_site_code_value, brood_yr:TRT) %>%
  filter(sbycode == "RAL") %>%
  group_by(TRT, spawn_yr) %>%
  count(mark_site_code_value) %>%
  spread(key = mark_site_code_value, value = n) %>%
  ungroup() %>%
  mutate(Total = select(., CLWH:NISP) %>% rowSums(na.rm = T)) %>%
  rename(`Spawn Year` = spawn_yr)

obs_table %>%
  mutate_at(vars(`Spawn Year`),
            list(as.factor)) %>%
  pander()

```
</center>

### Section 2. Expected precision of *pHOS* given current systematic PIT tagging of HNC adults at LGR

Next, we evaluated the expected precision (CV) of *pHOS* estimates given current PIT tagging rates of ad-intact adults, both wild (W) and hatchery (HNC) at LGR. This leverages the fact that all ad-intact adults trapped at LGR are already implanted with a PIT tag. Estimates of wild adult abundance across select TRT populations and locations in the SRB are already available from DABOM. Here, we will re-run DABOM for HNC individuals for SY 2017 through 2019 to get HNC abundance estimates for locations and populations where we already report W abundance using DABOM. The HNC and W abundance estimates, at the same spatial scales, can then easily be combined to estimate *pHOS* with uncertainty.

This evaluation ignores ad-clipped H adults, but is effective for estimating *pHOS* among ad-intact individuals and may be of particular interest for supplementation locations (e.g., South Fork Clearwater steelhead). Unfortunately, it seems there is no easy way to combine juvenile smolt release tagging (tag expansion approach) and adult tagging information at LGR (DABOM model, transition probability approach) to estimate hatchery abundance and *pHOS* using IPTDS observations.

### Section 3. Expected precision of *pHOS* by adding tagging of ad-clipped hatchery (H) adults at LGR

Finally, we evaluated the expected precision (CV) of *pHOS* estimates given additional (theoretical) tagging of ad-clipped hatchery (H) adults at LGR using a simulation approach. Here, again, we must ignore PIT tagged hatchery smolt releases and the tag expansion approach as the DABOM model is reliant on systematic tagging of the adult return. First, we demonstrate how an estimate of *pHOS* can be generated under the DABOM framework.

#### Mathematical Reasoning

The estimate of *pHOS* at any branch $i$ in the DABOM model can be written as

$$
\hat{pHOS_i} = \frac{\mu_{h,i}}{\mu_{h,i} + \mu_{w,i}}
$$

where $\mu_{h,i}$ and $\mu_{w,i}$ are the estimates of hatchery and wild fish who have escaped to spawn in branch $i$. Ignoring the subscript $i$, let $\sigma^2_h$ and $\sigma^2_w$ represent the variance of those estimates. Then we can re-write our equation for *pHOS* as a function of hatchery and wild escapement estimates, assuming they are independent of one another (and assuming multivariate normality):

$$
\begin{aligned}
\hat{pHOS} &= \frac{h}{h + w} = 
  g \left(
    \begin{array}{c}
      h \\ 
      w
    \end{array}
    \right) \\
\\
g \left(
  \begin{array}{c}
    h \\ 
    w
  \end{array}
  \right) &\sim N \left( 
  \begin{array}{c} 
    \mu_h \\ 
    \mu_w 
    \end{array}, 
    \left( 
    \begin{array}{cc}
      \sigma^2_h & 0 \\
      0 & \sigma^2_w
    \end{array}
      \right)  \right) \\
\\
  &\equiv N( \boldsymbol{\mu}, \Sigma)
\end{aligned}
$$

Then, via the delta method (or Taylor approximation) [@Doob1935], we can derive the variance of our estimates of *pHOS*:

$$
\begin{aligned}
Var(g) &= \left( \frac{ \partial g}{\partial h}, \frac{ \partial g}{\partial w} \right) \Sigma \left( \begin{array}{c} \frac{ \partial g}{\partial h} \\ \frac{ \partial g}{\partial w} \end{array} \right) \\
\\
&= \left( \frac{w}{(h+w)^2}, \frac{h}{(h+w)^2} \right) 
  \left( 
    \begin{array}{cc}
      \sigma^2_h & 0 \\
      0 & \sigma^2_w
    \end{array}
  \right) 
  \left( 
    \begin{array}{c}
    \frac{w}{(h+w)^2} \\
    \frac{h}{(h+w)^2}
    \end{array}
  \right)
\\
&= \left( \frac{w \sigma^2_h}{(h+w)^2}, \frac{h \sigma^2_w}{(h+w)^2} \right) 
    \left( 
    \begin{array}{c}
    \frac{w}{(h+w)^2} \\
    \frac{h}{(h+w)^2}
    \end{array}
  \right)
\\
&= \frac{w^2 \sigma^2_h + h^2 \sigma^2_w}{(h+w)^4},
\end{aligned}
$$

so the standard error of *pHOS* is

$$
SE(g) = \frac{w \sigma_h + h \sigma_w}{(h+w)^2},
$$

which implies that the CV of *pHOS* can be derived as

$$
\begin{aligned}
CV(g) &= \frac{SE(g)}{g} \\
\\
&= \frac{w \sigma_h + h \sigma_w}{(h+w)^2} * \frac{(h+w)}{h} \\
\\
&= \frac{w \sigma_h + h \sigma_w}{h(h+w)}\\
\\
&= \frac{h \sigma_w}{h(h+w)} + \frac{w \sigma_h}{h(h+w)} \\
\\
&= \frac{\sigma_w}{(h + w)} + \frac{w}{(h+w)} * \frac{\sigma_h}{h} \\
\\
&= \frac{w}{(h+w)} \left( \frac{\sigma_w}{w} + \frac{\sigma_h}{h} \right) \\
\\
&= \left(1 - pHOS \right) \left( \frac{\sigma_w}{w} + \frac{\sigma_h}{h} \right),
\end{aligned}
$$

which is a combination of the estimate of *pHOS*, the CV of the estimate of wild fish and the CV of the estimate of hatchery fish. This CV can easily be translated back to a standard error of *pHOS* as well, but is still based on those three numbers. In other words, we can predict the CV (or SE) of *pHOS* for a variety of situations for a given branch $i$ by varying the levels of *pHOS* in a stream, and the precision (or CV) of our escapement estimates of wild and hatchery fish in branch $i$. We simulated branches with *pHOS* levels ranging from 0 to 1, and precision of wild and hatchery escapement containing CVs of 0 to 1.5. We then calculated the predicted CV and SE of *pHOS* from those values, and compared the standard error to various thresholds. For each combination of *pHOS* and wild escapement precision, we extracted the maximum hatchery escapement CV that would allow us to meet or exceed the various thresholds for the *pHOS* standard error. 

#### Simulation

```{r viable-trts}
viable_trts = read_xlsx("../data/Snake River Steelhead populationproposed status.xlsx") %>%
  clean_names() %>%
  filter(grepl("Viable", proposed_status)) %>%
  pull(population) %>%
  toString()
```

From the DABOM estimates of wild escapement for spawn years 2013-2019, we first calculated the average CV of the wild abundance estimate for each population where IPTDS infrastructure is in place for population monitoring. We chose 2013 as the first year as IPTDS infrastructure in the SRB has been relatively stable since then (See et al. 2019). The average CVs of the wild estimates for each population show us where we fall on the x-axis in `r fig_nums('se_phos_fig', display = 'c')`. We then used the average estimate of *pHOS* from `r tab_nums("dabom_hnc_phos", display = "c")` for each population to determine where on the y-axis we are for each population. This assumes that the only hatchery fish on the spawning grounds within those populations are unclipped (HNC). 

If we know where on `r fig_nums('se_phos_fig', display = 'c')` most CVs of wild escapement among Snake River populations lie, and some estimate of *pHOS* for those populations, this will tell us the maximum CV of hatchery escapement we can obtain to still provide an estimate of *pHOS* with a standard error below a particular threshold. Finally, we can then translate that hatchery escapement CV into a number of tags we'd like to detect in each population. Here, we will focus on steelhead TRT populations with a proposed status of "Viable" or "Highly Viable" which includes the following: `r viable_trts`. 

<!--
We will also assume a 5% pHOS and 10% pHOS, based on recovery goals (***Is this necessary?***). I don't remember saying it was necessary to assume this. We're essentially using our available info on where we are on the x-axis and y-axis using available information right, to give us a ballpark of the max CV of hatchery escapements we can get away with and still estimate pHOS with a CV of 15% or less, correct? And then based on that determine the # of detections we need in a given population to obtain that CV. And then using Brian's information on transition probabilities we can back-calculate the number of tags needed at LGR (something similar to Figures 5 & 6 in See et al. 2019 TrapRateEffects)
-->

```{r stray-data}
leth_df = read_xlsx("../data/Percent of LGD PIT detections that stray 1-10-20.xlsx", 
                    range = "S63:AH74") %>%
  mutate_at(vars(`Upper Salmon`:Total), funs(as.numeric(.))) %>%
  mutate_at(vars(`Upper Salmon`:Total), ~. * 100) %>%
  mutate_if(is.numeric, ~round(.,3))

# which populations have never had a stray detected?
no_strays = leth_df %>%
  select(-Total) %>%
  gather(pop, rate, -`Release Group`) %>%
  filter(grepl('Weighted', `Release Group`),
         rate == 0) %>%
  pull(pop)
```

We also have information showing the percentage of hatchery adults, tagged as juveniles, that are detected within 'recipient populations' out of all the hatchery tags that are detected at LGR (and summarized by release groups; Brian Leth, IDFG, personal communication). We will divide the number of detections we require for each population by these percentages (`r tab_nums("stray_rates", display = "c")`) to determine how many tags we would expect to need to put out at Lower Granite in order to achieve determined precision goals. There are several populations that have never had an observed stray, so we will not be able to include them in the subsequent analysis (`r paste(no_strays, collapse = ', ')`). 

`r tab_nums('stray_rates')`
```{r stray-rates-v1}
pander(leth_df,
       emphasize.strong.rows = nrow(leth_df),
       emphasize.strong.cols = ncol(leth_df))
```

# Results

### Section 1. Expected precision of *pHOS* given current PIT tagging of hatchery smolt releases

`r tab_nums('juv_phos', display = 'c')` summarizes hatchery, wild, and total abundance estimates and the corresponding *pHOS* estimates for locations and spawn years in which there were IPTDS observations of hatchery adults from RTR smolt releases. Wild abundance estimates are from the DABOM model whereas hatchery abundance estimates are using the expansion approach outlined above. `r tab_nums('juv_phos', display = 'c')` also includes the number of hatchery and wild tags observed and the CV of the wild abundance estimates for context. Unfortunately, we are currently unable to estimate uncertainty in hatchery abundance, and thus, unable to estimate uncertainty in *pHOS* using this approach. To do so, we would have to identify and estimate sources of uncertainty in the hatchery abundance estimates; uncertainty in the tagging fraction (i.e., expansion value) would be one such example.

<!---
I'm wondering whether we need to or can remove hatchery rack returns from the hatchery abundance for particular TRT populations here? SRUMA-s comes to mind. Are there racks or weirs in CRSFC-s where hatchery steelhead are removed?
-->

`r tab_nums('juv_phos')`
<center>
```{r juv_phos}
pHOS_1a = final_sthd_obs %>%
  select(tag_code:expansion_value, mark_site_code_value, brood_yr:TRT) %>%
  filter(sbycode == 'RAL') %>%
  group_by(TRT, spawn_yr, mark_site_code_value) %>%
  summarise(Abundance = round(sum(expansion_value),0)) %>%
  spread(key = mark_site_code_value, value = Abundance) %>%
  ungroup() %>%
  mutate(`Hatchery Abundance` = select(., CLWH:NISP) %>% rowSums(na.rm = T)) %>%
  rename(`Spawn Year` = spawn_yr)
    
wild_abund = read_excel('../data/LGR_AllSummaries_Steelhead.xlsx',
                        sheet = 2) %>%
  select(TRT, spawn_yr,
         n_wild_tags = n_tags,
         median, cv) %>%
  mutate(cv = as.numeric(cv)) %>%
  filter(median != 0) %>%
  mutate(cv = cv*100) %>%
  rename(`Wild Abundance` = median,
         `CV (%)` = cv)

pHOS_1a = obs_table %>%
  mutate_at(vars(`Spawn Year`),
            list(as.numeric)) %>%
  select(TRT, `Spawn Year`,
         n_hatch_tags = Total) %>%
  left_join(pHOS_1a) %>%
  left_join(wild_abund, by = c("TRT" = "TRT",
                               "Spawn Year" = "spawn_yr")) %>%
  mutate(`Total Abundance` = `Hatchery Abundance` + `Wild Abundance`) %>%
  mutate(pHOS = round(`Hatchery Abundance`/`Total Abundance`,3)) %>%
  rename(`n. Tags Hatchery` = n_hatch_tags,
         `n. Tags Wild` = n_wild_tags)
pHOS_1a %>%
  mutate_at(vars(`Spawn Year`),
            list(as.factor)) %>%
  pander()

```
</center>

### Section 2. Expected precision of *pHOS* given current PIT tagging of W and HNC adults at LGR

We estimated the abundance of ad-intact adults using the systematic tagging of those adults at LGR, detection at IPTDS throughout the SRB, and using the DABOM model for steelhead, SY2017-2019 (`r tab_nums('dabom_hnc_phos', display = 'c')`). Abundances were then combined to estimate *pHOS* with SE and CV which accounts for uncertainty in both the wild and HNC abundance estimates.

```{r dabom_hnc, eval = F}
dabom_sthd_hnc_abund = read_csv("../hnc_dabom/ModelFits/Sthd_HNC_abund.csv")
pander(dabom_sthd_hnc_abund)
```

`r tab_nums('dabom_hnc_phos')`
```{r dabom_hnc_phos}
hnc_phos_sthd = read_csv("../hnc_dabom/ModelFits/Sthd_HNC_pHOS.csv")

phos_tab = hnc_phos_sthd %>%
  mutate(HNC = paste0(prettyNum(HNC, big.mark = ','), ' (', round(cv_hnc, 3), ')'),
         Wild = paste0(prettyNum(Wild, big.mark = ','), ' (', round(cv_wild, 3), ')')) %>%
  select(Year:TRT,
         HNC, 
         `HNC tags` = n_tags_hnc,
         Wild,
         `Wild tags` = n_tags_wild,
         starts_with('pHOS'))

trts = unique(hnc_phos_sthd$TRT)
yrs = unique(hnc_phos_sthd$Year)
hnc_phos = crossing(trts, yrs) %>%
  rename(TRT = trts,
         Year = yrs) %>%
  left_join(phos_tab) %>%
  select(-Species) %>% 
  mutate_at(vars(starts_with("pHOS")),
            list(round),
            digits = 3) %>%
  mutate_at(vars(Year),
            list(as.factor))

pander(hnc_phos)

# kable(hnc_phos)
```

### Section 3. Expected precision of *pHOS* by adding tagging of ad-clipped hatchery (H) adults at LGR

#### Mathematical Reasoning

```{r se-phos-dataframe}
# if pHOS is 0.50, and we want a CV of 0.15 for the precision, that would mean the SE is: 0.075
# so let's aim that that level of standard error
# seThres = 0.075
# seThres = 0.02
# seThres = 0.05

# throw out a few thresholds for standard error of pHOS, to see the effect of those different thresholds
sim_df = crossing(propWild = seq(0, 1, 0.01), # proportion of wild fish in the stream
         # CV of the estimate of wild fish
         cvW = seq(0, 1.5, 0.01),
         # CV of the estimate of hatchery fish
         cvH = seq(0, 1.5, 0.01),
         seThres = c(0.02, 0.05, 0.1, 0.25)) %>%
  mutate(pHOS = 1 - propWild,
         CV = propWild * (cvW + cvH),
         SE = CV * pHOS) %>%
  group_by(propWild, cvW, seThres) %>%
  filter(pHOS < 1,
         pHOS > 0,
         SE <= seThres) %>%
  filter(cvH == max(cvH)) %>%
  rename(maxHcv = cvH) %>%
  ungroup() %>%
  mutate(seFct = paste0('SE < ', seThres * 100, '%')) %>%
  mutate(seFct = fct_reorder(seFct,
                             seThres))
```

The results from our mathematical exploration are shown in `r fig_nums('se_phos_fig', display = 'c')`. The same general patterns hold for all four standard error thresholds we evaluated: it is easiest to meet the threshold when *pHOS* is very small or very large in that a wide range of precision in wild and hatchery escapement estimates will work. When *pHOS* is close to 50%, the number of combinations in escapement CVs that will meet each threshold is smaller, with some being impossible to meet unless the CVs of wild and hatchery escapement are both very small. 

As the precision of the wild estimates improves (i.e. smaller CV, to the left on `r fig_nums('se_phos_fig', display = 'c')`), there are more scenarios under which the precision of the *pHOS* estimate is reasonable. As a reference, the CVs of the estimates for spring/summer Chinook escapement to the Lemhi range from 0.1 to 0.25 for years 2010 - 2018. When *pHOS* is quit low or quite high (towards the bottom or top of `r fig_nums('se_phos_fig', display = 'c')`), then regardless of the CV of wild or hatchery escapement, reasonable precision of *pHOS* can be obtained. 

It is clear that the results are sensitive to different standard error thresholds. When the threshold is quite low, such as `r min(sim_df$seThres) * 100`%, it takes more precise estimates of wild and hatchery escapement to meet that threshold, which presumably will require more tags to be put out at Lower Granite. 


```{r cv-phos-fig, eval = F, fig.cap = fig_nums('cv_phos_fig')}
cvThres = 0.15
sim_df = crossing(propWild = seq(0, 1, 0.01), # proportion of wild fish in the stream
         # CV of the estimate of wild fish
         cvW = seq(0, 1, 0.01),
         # CV of the estimate of hatchery fish
         cvH = seq(0, 1.5, 0.01)) %>%
  mutate(pHOS = 1 - propWild,
         CV = propWild * (cvW + cvH)) %>%
  group_by(propWild, cvW) %>%
  summarise(nTot = n(),
            nPrec = sum(CV <= cvThres),
            maxHcv = max(cvH[CV <= cvThres])) %>%
  ungroup() 

sim_df %>%
  ggplot(aes(x = cvW,
             y = 1 - propWild)) +
  geom_tile(aes(fill = maxHcv)) +
  geom_contour(aes(z = maxHcv),
               color = 'black',
               bins = 10) +
  # geom_line(data = sim_df %>%
  #             filter(maxHcv == 0.15),
  #           color = 'red') +
  theme_classic() +
  geom_text(x = 0.75,
            y = 0.25,
            hjust = 'inward',
            vjust = 'inward',
            label = paste0('CV > ', cvThres, '%')) +
  scale_fill_viridis_c(na.value = 'gray90',
                       begin = 0.2) +
  labs(x = 'CV of Wild Escp.',
       # y = '% Wild',
       y = 'pHOS',  
       fill = 'Max CV\nHatch Est.')

```

```{r se-phos-fig, fig.cap = fig_nums('se_phos_fig'), fig.height = 7}
sim_df %>%
  filter(SE > 0) %>%
  ggplot(aes(x = cvW,
             y = pHOS)) +
  geom_tile(aes(fill = maxHcv)) +
  geom_contour(aes(z = maxHcv),
               color = 'black',
               bins = 10) +
  theme_classic() +
  scale_fill_viridis_c(na.value = 'gray90',
                       begin = 0.2) +
  facet_wrap(~ seFct) +
  theme(legend.position = 'bottom') +
  labs(x = 'CV of Wild Escp.',
       y = 'pHOS',  
       fill = 'Max CV\nHatch Est.')

```

#### Simulation

```{r dabom-wild-estimates}
pop_nms = read_excel('../data/Snake_River_TRT_Populations.xlsx') %>%
  filter(Species == 'Steelhead') %>%
  mutate(TRT = recode(TRT,
                      "IRMMT-s" = "IRMAI-s"))

wild_est = read_excel('../data/LGR_AllSummaries_Steelhead.xlsx',
                      sheet = 'Pop Total Esc') %>%
  filter(spawn_yr >= 2013) %>%
  mutate_at(vars(cv),
            list(as.numeric)) %>%
  select(-species) %>%
  left_join(pop_nms)

```

```{r tags-cv-model, eval = F}
# look at relationship visually, see which looks the most linear
p1 = wild_est %>%
  ggplot(aes(x = n_tags,
             y = cv)) +
  geom_point() +
  geom_smooth(aes(color = 'Loess',
                  fill = 'Loess'),
              alpha = 0.2) +
  geom_smooth(method = 'lm',
              aes(color = 'Linear',
                  fill = 'Linear'),
              alpha = 0.2) +
  scale_color_brewer(palette = 'Set1') +
  scale_fill_brewer(palette = 'Set1') +
  labs(color = 'Model',
       fill = "Model")
  
p2 = p1 +
  scale_x_continuous(trans = 'log',
                     breaks = scales::pretty_breaks())

p3 = p1 +
  scale_y_continuous(trans = 'log',
                     breaks = scales::pretty_breaks())

p4 = p1 +
  scale_x_continuous(trans = 'log',
                     breaks = scales::pretty_breaks()) +
  scale_y_continuous(trans = 'log',
                     breaks = scales::pretty_breaks())

ggpubr::ggarrange(plotlist = list(p1, p2, p3, p4),
                  nrow = 2,
                  ncol = 2,
                  common.legend = T,
                  legend = 'bottom')


# models for estimating CV of estimate, based on number of tags detected
# various combinations of logged dependent and independent variables
mod1 = lm(cv ~ n_tags,
          data = wild_est)
mod2 = lm(cv ~ log(n_tags),
          data = wild_est)
mod3 = lm(log(cv) ~ n_tags,
          data = wild_est)
mod4 = lm(log(cv) ~ log(n_tags),
          data = wild_est)

list(mod1 = mod1, 
     mod2 = mod2, 
     mod3 = mod3, 
     mod4 = mod4) %>%
  map_df(.id = 'Model',
         .f = function(x) {
           tibble(r_sq = summary(x)$r.squared,
                  adj_r_sq = summary(x)$adj.r.squared)
         })

list(mod1 = mod1, 
     mod2 = mod2, 
     mod3 = mod3, 
     mod4 = mod4) %>%
  map(.f = function(m) {
    tibble(resid = resid(m)) %>%
      ggplot(aes(x = resid)) +
      geom_histogram() +
      geom_vline(xintercept = 0,
                 linetype = 2,
                 color = 'red')
  }) %>%
  ggpubr::ggarrange(plotlist = .,
                    ncol = 2,
                    nrow = 2)

diag_plots = list(mod1 = mod1, 
                  mod2 = mod2, 
                  mod3 = mod3, 
                  mod4 = mod4) %>%
  map(.f = function(m) {
    autoplot(m, which = 1:6)
  })

diag_plots[[2]]
diag_plots[[4]]

```

```{r tags-vs-cv-model}
n_tags_mod = lm(log(cv) ~ log(n_tags),
          data = wild_est)

n_tags_sim = tibble(n_tags = seq(1, 1000)) %>%
# n_tags_sim = tibble(n_tags = seq(1, max(wild_est$n_tags, na.rm = T))) %>%
  mutate(cv = predict(n_tags_mod,
                      newdata = .,
                      type = 'response')) %>%
  mutate_at(vars(cv),
            list(exp))

tag_cv_p1 = wild_est %>%
  ggplot(aes(x = n_tags,
             y = cv)) +
  geom_point() +
  geom_hline(yintercept = 0.15,
             linetype = 2) +
  scale_color_brewer(palette = "Set1") +
  geom_smooth(aes(color = 'Semi-Log'),
              method = glm,
              method.args = list(family = gaussian(link = "log")),
              se = F,
              fullrange = T) +
  # geom_smooth(aes(color = 'Log'),
  #             method = lm,
  #             formula = y ~ log(x),
  #             se = F,
  #             fullrange = T) +
  geom_smooth(aes(color = 'Loess'),
              method = loess,
              se = F,
              fullrange = T) +
  geom_line(data = n_tags_sim,
            aes(color = 'Log-log'),
            lwd = 1) +
  coord_cartesian(xlim = c(0, max(wild_est$n_tags, na.rm = T))) +
  facet_wrap(~ Species) +
  labs(x = '# PIT Tags Detected',
       y = 'CV of Population Estimate',
       color = 'Model')

tag_cv_p2 = wild_est %>%
  ggplot(aes(x = n_tags,
             y = cv)) +
  geom_point() +
  geom_hline(yintercept = 0.15,
             linetype = 2) +
  geom_line(data = n_tags_sim,
            color = 'red',
            lwd = 1) +
  coord_cartesian(xlim = c(0, max(wild_est$n_tags, na.rm = T))) +
  facet_wrap(~ Species) +
  labs(x = '# PIT Tags Detected',
       y = 'CV of Population Estimate')

```

We modeled the relationship between the number of wild tags detected within a population and the CV of the wild abundance estimate using a log-log model (`r fig_nums("tags_cv_fig", display = 'c')`). We assumed the same relationship holds for hatchery tags detected. For each population, we used the average CV of the wild abundance estimates over the last several years and the average estimated *pHOS* levels from `r tab_nums('dabom_hnc_phos', display = 'c')` to determine the maximum CV of hatchery escapement such that we would meet the various thresholds for *pHOS* standard error. Based on the model shown in `r fig_nums("tags_cv_fig", display = 'c')`, we could then estimate how many tags would need to be detected to obtain that CV. From there, we divided that tag number by the weighted average of detected stray rates from `r tab_nums('stray_rates', display = 'c')` to estimate how many total tags would need to be deployed at Lower Granite to obtain that number of detections. The results are shown in `r tab_nums("lgr_tags_tab", display = 'c')`.

```{r tags-vs-cv-fig, fig.cap = fig_nums("tags_cv_fig")}
tag_cv_p2
```

```{r lgr-tags-estimate}
hatch_cv = wild_est %>%
  filter(mean > 0) %>%
  group_by(MPG_DPS, Name, TRT) %>%
  summarise_at(vars(cv),
               list(mean = mean, 
                    min = min,
                    max = max),
               na.rm = T) %>%
  ungroup() %>%
  select(MPG_DPS:TRT,
         cvW = mean) %>%
  mutate_at(vars(cvW),
            list(round),
            digits = 2) %>%
  left_join(hnc_phos %>%
              # mutate(propWild = 1 - pHOS) %>%
              group_by(TRT) %>%
              summarise_at(vars(pHOS),
                           list(mean),
                           na.rm = T) %>%
              mutate_at(vars(pHOS),
                        list(round),
                        digits = 2)) %>%
  full_join(wild_est %>%
              select(MPG_DPS, Name, TRT) %>%
              distinct() %>%
              crossing(seThres = unique(sim_df$seThres))) %>%
  # mutate(pHOS = if_else(pHOS == 0, 0.01, pHOS)) %>%
  left_join(sim_df %>%
              select(cvW, pHOS, maxHcv, seThres) %>%
              mutate_at(vars(maxHcv, pHOS),
                        list(round),
                        digits = 2)) %>%
  arrange(MPG_DPS, TRT, seThres) %>%
  mutate(n_tags = NA)

for(i in 1:nrow(hatch_cv)) {
  if(is.na(hatch_cv$maxHcv[i])) next
  
  min_tags = n_tags_sim %>%
    filter(cv <= hatch_cv$maxHcv[i]) %>%
    slice(1) %>%
    pull(n_tags)
  
  if(length(min_tags) == 0) min_tags = NA
  
  hatch_cv$n_tags[i] = min_tags
  rm(min_tags)
}

lgr_tags_df = hatch_cv %>%
  # filter(!is.na(n_tags)) %>%
  full_join(leth_df %>%
              filter(`Release Group` == "Weighted Average") %>%
              select(-`Release Group`, -Total) %>%
              gather(Pop, conv_rate) %>%
              # translate percent into actual number
              mutate_at(vars(conv_rate),
                        list(~ . / 100)) %>%
              # recode so we can join
              mutate(Pop = recode(Pop,
                                  'Pahsim.' = 'Pahsimeroi',
                                  'S.F. Clearwater' = 'South Fork Clearwater')) %>%
              mutate(Pop = str_remove(Pop, " River$"),
                     Pop = str_remove(Pop, " R.$"),
                     Pop = paste(Pop, "River"),
                     Pop = recode(Pop,
                                  "Lolo River" = "Lolo Creek",
                                  "Joseph River" = "Joseph Creek",
                                  "Asotin River" = "Asotin Creek")) %>%
              # not sure if these are correct or appropriate
              mutate(Pop = recode(Pop,
                                  "Grande Ronde River" = "Wallowa River",
                                  "Lower Snake River" = 'Tucannon River',
                                  "Upper Salmon River" = 'Upper Mainstem Salmon River',
                                  'Middle Fork Salmon River' = 'Lower Middle Fork Salmon River')) %>%
              rename(Name = Pop)) %>%
  mutate(LGR_tags = n_tags / conv_rate) %>%
  select(MPG_DPS:pHOS, seThres, maxHcv, n_tags, conv_rate, LGR_tags) %>%
  mutate_at(vars(LGR_tags),
            list(as.integer))

```

`r tab_nums("lgr_tags_tab")`
```{r lgr-tags-table}
lgr_tags_df %>%
  arrange(seThres, desc(LGR_tags)) %>%
  # filter(!is.na(conv_rate),
  #        !is.na(TRT)) %>%
  # filter(!is.na(LGR_tags)) %>%
  # group_by(seThres) %>%
  # arrange(desc(LGR_tags)) %>%
  # arrange(MPG_DPS, TRT) %>%
  kable(format.args = list(big.mark = ','))
```

We then examined the proportion of TRT populations that would have a reliable estimate of *pHOS* under different tagging scenarios at Lower Granite. Assuming a certain number of tags were deployed at Lower Granite, we determined which populations would have a standard error of *pHOS* below various thresholds, according to `r tab_nums("lgr_tags_tab", display = 'c')`. We then transformed that into a percent of all TRT populations where we expect to estimate *pHOS* (not including those with no observed strays: `r paste(no_strays, collapse = ', ')`). This included a total of `r filter(lgr_tags_df, conv_rate > 0) %>% summarise(tot_trt = n_distinct(TRT)) %>% pull(tot_trt)` TRT steelhead populations. Those results are shown in `r fig_nums("trt_prop_fig", display = 'c')`.

```{r lgr-pops, fig.cap = fig_nums("trt_prop_fig")}

lgr_tags_df %>%
  filter(conv_rate > 0) %>%
  mutate(tot_trt = n_distinct(TRT)) %>%
  crossing(tot_tags_deploy = c(seq(100, 1000, by = 50), seq(1100, 1e4, by = 100))) %>%
  mutate(sufficient = if_else(tot_tags_deploy >= LGR_tags,
                              T, F)) %>%
  filter(sufficient) %>%
  group_by(MPG_DPS, seThres, Name, TRT) %>%
  filter(tot_tags_deploy == min(tot_tags_deploy)) %>%
  group_by(tot_trt, seThres, tot_tags_deploy) %>%
  summarise(n_trt = n_distinct(TRT),
            which_trt = paste(TRT, collapse = ', ')) %>%
  ungroup() %>%
  group_by(seThres) %>%
  mutate(cum_trt = cumsum(n_trt),
         prop_trt = cum_trt / tot_trt) %>%
  ungroup() %>%
  mutate(seFct = paste0('SE < ', seThres * 100, '%')) %>%
  mutate(seFct = fct_reorder(seFct,
                             seThres)) %>%
  ggplot(aes(x = tot_tags_deploy,
             y = prop_trt,
             color = seFct)) +
  scale_color_brewer(palette = 'Set1') +
  # scale_color_viridis_d(end = 0.9) +
  # scale_x_continuous(trans = "log10",
  #                    breaks = scales::pretty_breaks()) +
  geom_point() + 
  geom_step() +
  geom_vline(xintercept = 4000,
             linetype = 2) +
  geom_label_repel(aes(label = which_trt),
                   show.legend = F,
                   force = 2,
                   size = 3) +
  facet_wrap(~ seFct) +
  theme(legend.position = 'bottom') +
  labs(x = '# Hatchery Tags Deployed at Lower Granite',
       y = expression(paste("Proportion of Monitored TRT Populations with Precise ", hat(pHOS))),
       color = 'SE Threshold')
  
```


# Discussion

Based on the number of detections of hatchery fish tagged as juveniles, relying on this type of data may not provide the reliable estimates of *pHOS* we are striving for. First of all, without uncertainty around the proportion of each release group tagged, there is no way to provide uncertainty with the *pHOS* estimates. Second, for many of these populations, *pHOS* estimates are based on a handful of detections, so they are very sensitive to small changes in the number of detections. Although estimates produced this way may be unbiased in general, for any particular populaiton in a particular year the estimates could be very wrong, with no way to capture the uncertainty in that. 

Estimates of *pHOS* based on escapement of unclipped hatchery fish (and wild fish) may be more reliable, but they only include the effects of unclipped hatchery fish. For some populations, this may be the majority of the hatchery fish found on the spawning grounds, but that may not be the case for all populations. Table `r tab_nums('dabom_hnc_phos', display = 'c')` shows that for many populations, there are very few HNC tags detected, leading to more uncertainty in the HNC abundance estimates and therefore more uncertainty in the *pHOS* estimates as well. This method may be appropriate for some populations, but the desired number of detections in those populations will need to be accounted for when setting the tagging or trapping rate at Lower Granite.

Finally, tagging clipped hatchery fish at Lower Granite could provide estimates of *pHOS* that are reasonably precise, depending on the threshold for "reasonable". For some populations with very low incoming stray rates, this method may never provide a reliable estimate of hatchery fish because we just won't ever have enough detections. For others, this method could work very well, even with relatively few tags being deployed at Lower Granite. The key for those situations would be ensuring that tags were still a random, representative sample of the entire clipped hatchery group moving past LGR. 

It may be possible to incorporate all of this data and all these detections into a larger, hierarchical model that borrows information about *pHOS* from populations with more detections (i.e. more precise estimates of wild and hatchery escapement) and spreads that out amongst populations with fewer detections. Knowing that these populations are not completely independent, especially when it comes to stray rates, some form of spatial autocorrelation should probably be incorporated into such a model. Such a framework may work best across multiple years as well, although if the spatial autocorrelation structure changes, perhaps to due to shifting release numbers from various hatcheries, this could confound such an effort. 

## Assumptions and Considerations

* HNC estimates of *pHOS* are reasonable estimates to start with. They may be underestimating *pHOS* if those populations also experience large numbers of clipped hatchery fish on the spawning grounds. How likely is that?
* The weighted averages of stray rates also incorporate the impacts of fishing on the mainstem. Will those impacts (i.e. harvest rate) remain fairly constant? 

<!-- ## Next Steps -->

<!-- * Incorporate results and implications from Craig Busack's script located in ../R/idahopit.R -->
<!--     + from Lance Hebdon, August 5, 2019: I would contact Busack directly, we never saw any specific analysis only Craig's description of how low a confidence we would have given the low tag rates and detection rates at a single array in a  single year basis.  Also some of the issues we had with Craig's analysis was his assumption that straying was equal across the landscape, as opposed to straying being more likely near the release points, the effect of transportation on straying, the ability to aggregate information from multiple years to further understand patterns in straying, and a few other things that I don't have on the top of my head. -->
<!-- * Identify 2-3 locations of interest for each Chinook salmon and steelhead to perform evaluations -->
<!-- * Do we need to perform a PTAGIS query for particular locations to identify HOR observations; and can we track down release 'groups' for each observation? -->


<!-- ## Assumptions and Considerations -->

<!-- * What are the appropriate transition probabilities for hatchery fish along model branches? Need to consider harvest of hatchery fish. Presumably transition probabilities are lower for hatchery fish (relative to natural origin fish) due to harvest. -->
<!-- * Do hatchery fish mimic movement of wild fish? Probably not, due to the location of origin hatcheries and releases. -->
<!-- * Do some branches contain 0 hatchery fish? -->
<!-- * Should branches further upstream of LGR automatically include lower transition probabilities due to fishing on the mainstem? -->
<!-- * Do we need to accommodate time-varying movement probabilities in the simulation? -->
<!-- * Appropriate detection probabilities for each detection node in the simulation model. -->
<!-- * We must assume a fraction of hatchery fish will be harvested prior to reaching tributary habitats. -->
<!-- * How many total hatchery fish escape past LGR? We can run STADEM to determine range of values over the last several years. -->
<!-- * Is 15% CV for pHOS an appropriate, or even achievable, goal? -->

# References

See, K., M. Ackerman, and K. Meier. 2019. Tagging Rate at Lower Granite Dam. Markdown report prepared by Biomark, Inc.

<!---

## SCRAP

But then what's the next step here? To do an empirical evaluation we would then need to do a PTAGIS query of HOR observations across SRB IPTDS and be able to 'assign' each observation back to a release 'group'. Not a trivial task. And going down this path seems to require HOR runs of DABOM. 

Maybe it makes sense to include Craig Busack's demonstration here to show that, even given high detection probabilities, it may be difficult to observe HOR fish at a given location if tagging rates and number of fish are low, which could lead to biased estimates of *pHOS* at given locations if only juvenile observations are used.

### Methods Section 3
  
Now we need to figure out, depending on results from Section #2, what level of additional tagging (number or rate) is needed for HOR adults at LGR to achieve reasonable CVs for estimates of *pHOS*. This additional tagging would likely be targeted at just ad-clipped (H) fish. In this case, we could also easily calculate the tagging fraction by species x release group x brood year for adults except in this case we can ignore both $g$ and $y$ because those should be equal across groups! i.e., because we are tagging at LGR. However, we do need to account for differential tagging fractions between H and HNC, however, HNC could be set equal to the W tagging fraction (i.e., all ad-intact fish are tagged at the same rate). The final consideration to make is whether we need a time varying component in tagging fractions for juveniles and adults. I'm thinking we make a simplifying assumption here and ignore a time-varying component for this exercise.

Here's where I need help. How do we than calculate the 'overall or global' tagging fraction for a group i.e., the tagging fraction after considering juvenile and adult tagging for a given release group? And then use that to calculate abundance for that release group? And then sum across groups? Are tagging fractions for a group a summation across life stage tagging fractions? Need to clean up some of my notation and thoughts here?

In the end, for Methods section #3, perhaps it makes most sense to ignore juvenile PIT tagging fractions and simply focus on adult tagging at LGR due to 1) low juvenile tag rates and 2) complexity of problem. 

Alternatively, to determine the appropriate level of tagging, we may examine the last several years of DABOM results and focus on the number of tags observed within a few different tributaries and the level of precision of the accompanying escapement estimates, accounting for detection probability. We could then build a relationship to predict the precision based on the number of tags detected and the detection probability. After making some assumptions about the transition probability of hatchery fish to a particular tributary, we can use the estimate of detection probability to predict the precision of the escapement estimate under a variety of tagging rates.

## Simulation Description
  
The $\hat{pHOS}$ to a given location $j$ can simply be estimated as the ratio of all hatchery fish returning to a location, divided by total (i.e., hatchery and wild) fish returning. And in the case of hatchery fish, we need to account for broodstock removal and harvest (if any).

$$
\hat{pHOS} = \frac{\hat{N}_{j,H} - (Broodstock + Harvest)}{\hat{N}_{j,W} + (\hat{N}_{j,H} - (Broodstock + Harvest))}
$$

Typically, in STADEM and DABOM we estimate weekly escapement past LGR (STADEM) and weekly movement probabilities (DABOM). However, for the purposes of this simulation, perhaps we can assume similar run timings between hatchery and wild fish and among branches. And thus, wild and hatchery abundance to a given location $j$ could be simply estimated as

$$\hat{N}_{j,H} = X_H\psi_{j,H}$$
$$\hat{N}_{j,W} = X_W\psi_{j,W}$$

where $X$ is the escapement past LGR and $\psi$ is the movement probability for hatchery ($H$) and wild ($W$) fish, respectively.

-->

