---
title: "Hatchery Tagging to Estimate pHOS Using IPTDS Detections"
author:
  - Kevin See^[Biomark, Inc.]
  - Mike Ackerman^[Biomark, Inc.]
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  pdf_document:
    fig_caption: yes
    fig_height: 6
    fig_width: 7
    toc: yes
  html_document:
    fig_caption: yes
    fig_height: 8
    fig_width: 8
    theme: cerulean
    toc: yes
    toc_float:
      collapsed: yes
      smooth_scroll: yes
  word_document:
    fig_caption: yes
    fig_width: 7
    fig_height: 7
    toc: yes

#bibliography: ../references/bibliography.bib
#csl: ../references/american-fisheries-society.csl
---

```{r setUp, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
library(knitr)
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)

library(captioner)
tab_nums = captioner(prefix = 'Table')
fig_nums = captioner()

library(pander)
# options for table formatting
panderOptions('big.mark', ',')
panderOptions('keep.trailing.zeros', FALSE)
panderOptions('table.split.table', Inf)

# load necessary packages
library(tidyverse)
```

# Introduction

The Dam Adult Branch Occupancy Model (DABOM) is currently used to estimate adult escapement of natural origin spring/summer Chinook salmon and steelhead into watersheds and populations of the of the Snake River Basin (SRB). Escapement estimates are made based on the tagging of a random sample of adults at Lower Granite Dam (LGR) and the subsequent detection of those adults at instream PIT tag detection systems (IPTDS) throughout the SRB. DABOM could also be used to generate estimates of hatchery escapement to various locations as well, which would be useful for estimating hatchery abundance in natural areas and the proportion of hatchery origin spawners (*pHOS*). Doing so, with reasonable precision, may require a random sample (or similar) of adult hatchery fish also be PIT tagged at LGR. Here, we wish to determine expected levels of precision for *pHOS* given current levels of PIT tagging in the SRB, and further, determine the additional tagging, expressed as a tagging rate or number of tags, required in hatchery adults at LGR to achieve unbiased estimates of hatchery escapement and *pHOS* with reasonable levels of precision (e.g, coefficient of variaion [CV] of $\leq$ 15%).

Simultaneously estimating escapement of hatchery-origin (HOR) and natural-origin (NOR) adults to IPTDS locations throughout the SRB based on PIT tagging at LGR is a trivial extension of the DABOM model. Factually, the previous and existing instance of the DABOM model was developed for the upper Columbia River (upstream of Priest Rapids Dam), which capitalized on the same sampling assumptions applied to natural-origin escapement past LGR. However, for multiple reasons (ergonomic limitations at LGR, political considerations, as supposed ethical concerns), PIT tagging of HOR adults at LGR has been precluded. Notably, given trap operations at LGR, HOR adults are trapped, anesthetized, weighed, and measured at the same rate as NOR - a function of "trap rate" constituting a fraction of every hour wherein adults in the ladder are bypassed to the trap. Thus, it is arguable that implantation of a PIT tag constitutes a significantly greater offense to captured adults.

Unbeknownst to the proposal for this evaluation, a condition of the Hatchery and Genetics Management Plan (HGMP) required the operation of IDFG HOR steelhead production to conduct a study on HOR contirbution to NOR populations. Thusly, IDFG and NOAA Fisheries endeavored to compile and estimate straying of HOR steelhead upstream of LGR.

This document seeks to begin collaboration between IDFG, NOAA Fisheries, and Biomark to:

1. Capitalize on existing progress on stray rates, and
2. Advance statistical modeling to determine whether *pHOS* estimates can be reliablly prosecuted by adult HOR PIT tagging at LGR.

In its developed form, the DABOM model includes escapement for HOR and NOR adult salmonids. Demonstrably, the DABOM is fully functional for multiple populations of spring/summer chinook salmon and steelhead upstream of LGR. The performance of DABOM in the upper Columbia River (above Priest Rapids Dam) strongly suggests that the model can be reliably extended to HOR.

This document will be included as part of a Final (Annual) Progress Report for Bonneville Power Administration (BPA) project 2019-006-00.

## Objectives

This assessment aims to determine the sampling/PIT-tagging number/rate at LGR necessary to determine *pHOS* across populations of spring/summer Chinook salmon and steelhead estimated by the DABOM model (supported by the operation of IPTDS supported by BPA project 2018-002-00), within "reasonable" statistical parameters (e.g., CV $\leq$ 15%).

First, we want to know expected coefficients of variation (CV) for current estimates of *pHOS* that could be generated for Chinook salmon and steelhead populations in the SRB given current levels of PIT tagging. Current tagging would include previously tagged fish that arrive at LGR with a PIT tag (NOR and HOR), and additionally, ad-intact fish that are systematically PIT tagged at LGR to evaluate abundance and composition at LGR (e.g., Camacho *et al.* 2017) and at IPTDS (e.g., Orme and Kinzer 2018) throughout the SRB. Previously PIT tagged hatchery fish would largely be from hatchery smolt releases.

Importantly, currently three "origins" of adult Chinook salmon and steelhead are identified at LGR and include wild (W), hatchery ad-intact (HNC), and hatchery ad-clipped (H). NOR only includes W adults; NOR includes both the HNC and H groups. Currently, all ad-intact fish are systematically PIT tagged at LGR which includes both the W and HNC origins i.e., some HOR adults are currently tagged at LGR, but we need to consider differential tagging rates between HNC and H adults.

Second, our goal is to determine what levels of additional tagging at LGR of adult HOR fish would allow reasonable estimates of *pHOS*. We will define reasonable as an estimate with a CV of 15% or less. Our evaluation may (or may not) attempt to focus on desired or critical populations/locations.

# Methods

## Brainstorming (Delete Later)

Kevin, how do we want to approach this? One possible structure is to include 3 potential sections in the Methods and Results perhaps including:

1. The mathematical reasoning on how to calculate *pHOS* for any given branch *i* and their CV using the DABOM framework
2. Expected CVs for *pHOS* estimates given current PIT tagging rates in the SRB
3. Additional adult HOR PIT tagging that would be needed at LGR to achieve CVs of 15% or less, perhaps at target locations/populations

### Methods Section 2

For section 2, we need to make a decision on whether to account for PIT tagged HOR juvenile releases. HOR juvenile tagging fractions $\phi$ can differ by release group $g$, year $y$, and mark type $m$ (HNC or H). For any given return year, you perhaps need to account for several (perhaps 10 - 100) different tagging fractions. This could be compiled from IDFG, I'm just uncertain how readily available that information is. In many cases, these tagging fractions $\phi$, can be small, but in particular, and perhaps important locations, the tagging fraction can be high (e.g., South Fork Clearwater steelhead supplementation releases). Although, for a given DABOM branch $i$ you likely only need to account for a handful of tagging fractions $\phi_{gym}$, it is still useful to have those for all releases.

Then, for returning adults (tags), observations at branch $i$ could be expanded by the tagging fraction $\phi$ and detection probability $\psi$ for each combination of release group $g$, year $y$, and mark type $m$ (HNC or H), where 

$$
\mu_{hi} = \frac{n_{higym}}{\phi_{higym}*\psi_{higym}}
$$
except sum over all combinations of $g$, $y$, and $m$. Oh geez, help me out with my notation here!

For this above scenario, we might also account for the newly tagged HNC adults at LGR as well (i.e., all ad-intact adults captured at the trap are PIT tagged including HNC). Note, we don't need to account for differential survial among groups; we are only interested in tagging fractions withing groups, as long as we are willing to assume equal survival between tagged and untagged fish within groups.

But then what's the next step here? To do an empirical evaluation we would then need to do a PTAGIS query of HOR observations across SRB IPTDS and be able to 'assign' each observation back to a release 'group'. Not a trivial task. And going down this path seems to require HOR runs of DABOM. 

### Methods Section 3

Now we need to figure out, depending on results from Section #2, what level of additional tagging (number or rate) is needed for HOR adults at LGR to achieve reasonable CVs for estimates of *pHOS*. This additional tagging would likely be targeted at just ad-clipped (H) fish. In this case, we could also easily calculate the tagging fraction by species x release group x brood year for adults except in this case we can ingore both $g$ and $y$ because those should be equal across groups! i.e., because we are tagging at LGR. However, we do need to account for differential tagging fractions between H and HNC, however, HNC could be set equal to the W tagging fraction (i.e., all ad-intact fish are tagged at the same rate). The final consideration to make is whether we need a time varying component in tagging fractions for juveniles and adults. I'm thinking we make a simplifying assumption here and ignore a time-varying component for this exercise.

Here's where I need help. How do we than calculate the 'overall or global' tagging fraction for a group i.e., the tagging fraction after considering juvenile and adult tagging for a given release group? And then use that to calculate abundance for that release group? And then sum across groups? Are tagging fractions for a group a summation across life stage tagging fractions? Need to clean up some of my notation and thoughts here?

In the end, for Methods section #3, perhaps it makes most sense to ignore juvenile PIT tagging fractions and simply focus on adult tagging at LGR due to 1) low juvenile tag rates and 2) complexity of problem. 

## Simulation (and Mathematical Reasoning)

First, we demonstrate how an estimate of *pHOS* can be generated under the DABOM framework. The estimate of *pHOS* at any branch *i* in the DABOM model can be written as

$$
\hat{pHOS_i} = \frac{\mu_{h,i}}{\mu_{h,i} + \mu_{w,i}}
$$

where $\mu_{h,i}$ and $\mu_{w,i}$ are the estimates of hatchery and wild fish who have escaped to spawn in branch $i$. Ignoring the subscript $i$, let $\sigma^2_h$ and $\sigma^2_w$ represent the variance of those estimates. Then we can re-write our equation for *pHOS* as a function of hatchery and wild escapement estimates, assuming they are independent of one another (and assuming multivariate normality):

$$
\begin{aligned}
\hat{pHOS} &= \frac{h}{h + w} = 
  g \left(
    \begin{array}{c}
      h \\ 
      w
    \end{array}
    \right) \\
\\
g \left(
  \begin{array}{c}
    h \\ 
    w
  \end{array}
  \right) &\sim N \left( 
  \begin{array}{c} 
    \mu_h \\ 
    \mu_w 
    \end{array}, 
    \left( 
    \begin{array}{cc}
      \sigma^2_h & 0 \\
      0 & \sigma^2_w
    \end{array}
      \right)  \right) \\
\\
  &\equiv N( \boldsymbol{\mu}, \Sigma)
\end{aligned}
$$

Then, via the delta method (or Taylor approximation) [@Doob1935], we can derive the variance of our estimates of *pHOS*:

$$
\begin{aligned}
Var(g) &= \left( \frac{ \partial g}{\partial h}, \frac{ \partial g}{\partial w} \right) \Sigma \left( \begin{array}{c} \frac{ \partial g}{\partial h} \\ \frac{ \partial g}{\partial w} \end{array} \right) \\
\\
&= \left( \frac{w}{(h+w)^2}, \frac{h}{(h+w)^2} \right) 
  \left( 
    \begin{array}{cc}
      \sigma^2_h & 0 \\
      0 & \sigma^2_w
    \end{array}
  \right) 
  \left( 
    \begin{array}{c}
    \frac{w}{(h+w)^2} \\
    \frac{h}{(h+w)^2}
    \end{array}
  \right)
\\
&= \left( \frac{w \sigma^2_h}{(h+w)^2}, \frac{h \sigma^2_w}{(h+w)^2} \right) 
    \left( 
    \begin{array}{c}
    \frac{w}{(h+w)^2} \\
    \frac{h}{(h+w)^2}
    \end{array}
  \right)
\\
&= \frac{w^2 \sigma^2_h + h^2 \sigma^2_w}{(h+w)^4},
\end{aligned}
$$

so the standard error of *pHOS* is

$$
SE(g) = \frac{w \sigma_h + h \sigma_w}{(h+w)^2},
$$

which implies that the CV of *pHOS* can be derived as

$$
\begin{aligned}
CV(g) &= \frac{SE(g)}{g} \\
\\
&= \frac{w \sigma_h + h \sigma_w}{(h+w)^2} * \frac{(h+w)}{h} \\
\\
&= \frac{w \sigma_h + h \sigma_w}{h(h+w)}\\
\\
&= \frac{h \sigma_w}{h(h+w)} + \frac{w \sigma_h}{h(h+w)} \\
\\
&= \frac{\sigma_w}{(h + w)} + \frac{w}{(h+w)} * \frac{\sigma_h}{h} \\
\\
&= \frac{w}{(h+w)} \left( \frac{\sigma_w}{w} + \frac{\sigma_h}{h} \right),
\end{aligned}
$$

which is a combination of the proportion of wild fish, the CV of estimate of wild fish and the CV of the estimate of hatchery fish.

In other words, we can predict the CV of *pHOS* for a variety of situations for a given branch *i* by varying the percent wild fish in a stream, and the precision (or CV) of our escapement estimates of wild and hatchery fish in branch *i*. We selected several levels of precision in our estimates of wild fish, with CVs from 0.01 to 0.5, and a range of precision in our hatchery estimates, with CVs from 0 to 1.5, and then calculated the predicted CV of *pHOS* on those values.

```{r captions}

tradeoff_fig = fig_nums('tradeoff_fig',
                        "Predictions of the CV of pHOS across ranges of the CV hatchery and wild escapement estimates and the proportion wild (inverse of pHOS). The horizontal dotted line depicts a CV of 15%.")

```

# Results

## Simulation (and Mathematical Reasoning)

We predicted the CV of *pHOS* across a range of values for both hatchery escapement CV (0 - 1.5) and proportion wild (i.e., inverse of *pHOS*). The results are shown in `r fig_nums('tradeoff_fig', display = 'c')`.

```{r tradeoff_fig, fig.cap = fig_nums('tradeoff_fig')}
# proportion of wild fish in the stream
propWild = seq(0.05, 0.95, 0.05)
# CV of the estimate of wild fish
cvW = c(0.01, 0.05, 0.1, 0.15, 0.2, 0.25, 0.3, 0.4, 0.5)
# CV of the estimate of hatchery fish
cvH = seq(0, 1.5, 0.05)

crossing(propWild, cvW, cvH) %>%
  mutate(pHOS = 1 - propWild,
         CV = propWild * (cvW + cvH)) %>%
  mutate_at(vars(propWild, cvW),
            list(as.factor)) %>%
  ggplot(aes(x = cvH,
             y = CV,
             group = propWild,
             color = as.numeric(as.character(propWild)))) +
  scale_color_viridis_c(direction = -1,
                        end = 0.9,
                        option = 'C') +
  geom_line() +
  # geom_point() +
  geom_hline(yintercept = 0.15,
             linetype = 2,
             color = 'black') +
  # geom_vline(xintercept = 0.15,
  #            linetype = 2,
  #            color = 'black') +
  theme_bw() +
  theme(legend.position = 'bottom') +
  facet_wrap(~ cvW,
             ncol = 3) +
  # facet_grid(propWild ~ cvW) +
  labs(x = 'CV of Hatchery Escp.',
       y = 'CV of pHOS',
       color = '% Wild')
```

The general patterns show that as the proportion of wild fish in the stream descreases, the precision of *pHOS* improves for a given precision level of wild and hatchery escapement estimates. Also, as the precision of the wild estimates improves (i.e. smaller CV), there are more scenarios under which the precision of the *pHOS* estimate is reasonable. As a reference, the CVs of the estimates for spring/summer Chinook escapement to the Lemhi range from 0.1 to 0.25 for years 2010 - 2018. 

Another way to look at it would be to examine the maximum CV of hatchery estimates that would provide a reasonable estimate of *pHOS* for a given proportion of wild fish and precision of wild escapement. One way to visualize these results in in the plot below.

```{r}
cvThres = 0.15
crossing(propWild = seq(0, 1, 0.01), # proportion of wild fish in the stream
         # CV of the estimate of wild fish
         cvW = seq(0, 1, 0.01),
         # CV of the estimate of hatchery fish
         cvH = seq(0, 1.5, 0.03)) %>%
  mutate(pHOS = 1 - propWild,
         CV = propWild * (cvW + cvH)) %>%
  group_by(propWild, cvW) %>%
  summarise(nTot = n(),
            nPrec = sum(CV <= cvThres),
            maxHcv = max(cvH[CV <= cvThres])) %>%
  ungroup() %>%
  ggplot(aes(x = cvW,
             y = propWild)) +
  geom_tile(aes(fill = maxHcv)) +
  geom_contour(aes(z = maxHcv),
               color = 'black',
               bins = 10) +
  theme_minimal() +
  geom_text(x = 0.75,
            y = 0.75,
            hjust = 'inward',
            vjust = 'inward',
            label = paste0('CV > ', cvThres, '%')) +
  scale_fill_viridis_c(na.value = 'gray90',
                       begin = 0.2) +
  labs(x = 'CV of Wild Escp.',
       y = '% Wild',
       fill = 'Max CV\nHatch Est.')

```

From this plot, it is clear that as long as the proportion of wild fish in a stream is below a certain threshold (around 10%), then regardless of the CV of wild or hatchery escapement, reasonable precision of *pHOS* will be obtained. 

## Assumptions From Scope of Work

* What are the appropriate transition probabilities for hatchery fish along model branches? Need to consider harvest of hatchery fish. Presumably transition probabilities are lower for hatchery fish (relative to natural origin fish) due to harvest.
* Do hatchery fish mimic movement of wild fish? Probably not, due to the location of origin hatcheries and releases.
* Do some branches contain 0 hatchery fish?
* Should branches further upstream of LGR automatically include lower transition probabilities due to fishing on the mainstem?
* Do we need to accomodate time-varying movement probabilities in the simulation?
* Appropriate detection probabilities for each detection node in the simulation model.
* We must assume a fraction of hatchery fish will be harvested prior to reaching tributary habitats.
* How many total hatchery fish escape past LGR? We can run STADEM to determine range of values over the last several years.

Alternatively, to determine the appropriate level of tagging, we may examine the last several years of DABOM results and focus on the number of tags observed within a few different tributaries and the level of precision of the accompanying escapement estimates, accounting for detection probability. We could then build a relationship to predict the precision based on the number of tags detected and the detection probability. After making some assumptions about the transition probability of hatchery fish to a particular tributary, we can use the estimate of detection probability to predict the precision of the escapement estimate under a variety of tagging rates.

## Comments from Lance H. August 5, 2019

I would contact Busack directly, we never saw any specific analysis only Craig’s description of how low a confidence we would have given the low tag rates and detection rates at a single array in a  single year basis.  Also some of the issues we had with Craig’s analysis was his assumption that straying was equal across the landscape, as opposed to straying being more likely near the release points, the effect of transportation on straying, the ability to aggregate information from multiple years to further understand patterns in straying, and a few other things that I don’t have on the top of my head.  

## Comment from Bill S. October 8, 2019

We need to account for the fact that adult hatchery fish at LGR come in two flavors: ad-intact and ad-clipped. Darren currently PIT-tags all ad-intact fish that are trapped, both hathcery and wild (that don't have a previous PIT tag). So it seems that our major objective #2 (how many additional hatchery adults at LGR need to be PIT tagged) should focus on ad-clipped adults only.

In other words, we need to account for differential tagging rates between ad-clipped and ad-intact (HNC) when estimating pHOS for objective #2.

## Deliverable/Outcome

A statistical evaluation of bias/reliability of pHOS estimates that could be achieved for Snake River spring/summer Chinook salmon and steelhead given varying rates of HOR PIT tagging at LGR.

## Additional Considerations and Assumptions

* Is 15% CV for pHOS an appropriate, or even achievable, goal?

## Potential Useful Data Sources

## Simulation Description

The $\hat{pHOS}$ to a given location $j$ can simply be estimated as the ratio of all hatchery fish returning to a location, divided by total (i.e., hatchery and wild) fish returning. And in the case of hatchery fish, we need to account for broodstock removal and harves (if any).

$$\hat{pHOS} = \frac{\hat{N}_{j,H} - (Broodstock + Harvest)}{\hat{N}_{j,W} + (\hat{N}_{j,H} - (Broodstock + Harvest))}$$
Typically, in STADEM and DABOM we estimate weekly escapement past LGR (STADEM) and weekly movement probabilities (DABOM). However, for the purposes of this simulation, perhaps we can assume similar run timings between hatchery and wild fish and among branches. And thus, wild and hatchery abundance to a given location $j$ could be simply estimated as
$$\hat{N}_{j,H} = X_H\psi_{j,H}$$
$$\hat{N}_{j,W} = X_W\psi_{j,W}$$
where $X$ is the escapement past LGR and $\psi$ is the movement probability for hatchery ($H$) and wild ($W$) fish, respectively.

# References

Camacho, C.A., K.K. Wright, J. Powell, W.C. Schrader, T. Copeland, M.W. Ackerman, M. Dobos, M.P. Corsi, and M.R. Campbell. 2017. Wild adult steelehad and Chinook salmon abundance and composition at Lower Granite Dam, spawn years 2009-2016. Cumulative Report 2009 through 2016. Idaho Department of Fish and Game Report 17-06.

Doob, J.L. 1935. The limiting distributions of certain statistics. The Annals of Mathematical Statistics 6:160-169.

Orme, R. and R. Kinzer. 2018. Integrated In-stream PIT Tag Detection System Operations and Maintenance; PIT Tag Based Adult Escapement Estimates for Spawn Years 2016 and 2017. Nez Perce Tribe Department of Fisheries Resource Management. Prepared for: Quantititative Consultants, Inc.
