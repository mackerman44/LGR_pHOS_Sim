---
title: "Hatchery Tagging to Estimate pHOS Using IPTDS Detections"
author:
  - Kevin See^[Biomark, Inc.]
  - Mike Ackerman^[Biomark, Inc.]
date: '`r format(Sys.Date(), "%B %d, %Y")`'
output:
  html_document:
    fig_caption: yes
    fig_height: 8
    fig_width: 8
    theme: cerulean
    toc: yes
    toc_float:
      collapsed: yes
      smooth_scroll: yes
  word_document:
    fig_caption: yes
    fig_width: 7
    fig_height: 7
    toc: yes
  pdf_document:
    fig_caption: yes
    fig_height: 6
    fig_width: 7
    toc: yes
#bibliography: ../references/bibliography.bib
#csl: ../references/american-fisheries-society.csl
---

```{r setUp, echo=FALSE, message=FALSE, warning=FALSE, results='hide'}
library(knitr)
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)

library(captioner)
tab_nums = captioner(prefix = 'Table')
fig_nums = captioner()

library(pander)
# options for table formatting
panderOptions('big.mark', ',')
panderOptions('keep.trailing.zeros', FALSE)
panderOptions('table.split.table', Inf)

# load necessary packages
library(tidyverse)
```

# Introduction

The Dam Adult Branch Occupancy Model (DABOM) is currently used to estimate adult escapement of natural origin Chinook salmon into watershed and populations of the Snake River Basin (SRB). Escapement estimates are made based on the tagging of a random sample of adults at Lower Granite Dam (LGR) and the subsequent detection of those adults at instream PIT tag detections systems (IPTDS) throughout the basin. DABOM could also be used to generate estimates of hatchery escapement to various locations as well, which would be useful for estimating hatchery abundance in natural areas and the proportion of hatchery origin spawners (*pHOS*). Doing so, with reasonable precision, may require a random sample of hatchery fish be PIT tagged at LGR. Here, we aim to determine the tagging rate or number of tags required in hatchery adults at LGR to achieve unbiased estimates of hatchery escapement and *pHOS* with reasonable levels of precision.

## Objective

First, we want to know expected coefficients of variation (CV) for current estimates of *pHOS* that could be generated for Chinook salmon and steelhead populations in the SRB given current levels of PIT tagging. Current tagging would include previously tagged fish that arrive at LGR with a PIT tag (natural and hatchery origin), and additionally, natural origin fish that are systematically PIT tagged at LGR to evaluate abundance and composition at LGR (e.g., Camacho *et al.* 2017) and at IPTDS (e.g., Orme and Kinzer 2018) throughout the SRB. Previously PIT tagged hatchery fish would largely be from hatchery smolt releases.

Second, our goal is to determine what level of additional tagging at LGR of adult hatchery fish would allow reasonable estimates of *pHOS*. We will define reasonable as an estimate with a CV of 15% or less. Our evaluation will attempt to focus on desired or critical populations/locations.

# Methods

## Simulation

### Mathematical Reasoning

The estimate of *pHOS* any any branch *i* in the DABOM model can be written as

$$
\hat{pHOS_i} = \frac{\mu_{h,i}}{\mu_{h,i} + \mu_{w,i}}
$$

where $\mu_{h,i}$ and $\mu_{w,i}$ are the estimates of hatchery and wild fish who have escaped to spawn in branch $i$. Ignoring the subscript $i$, let $\sigma^2_h$ and $\sigma^2_w$ represent the variance of those estimates. Then we can re-write our equation for *pHOS* as a function of hatchery and wild escapement estimates, assuming they are independent of one another (and assuming multivariate normality):

$$
\begin{aligned}
\hat{pHOS} &= \frac{h}{h + w} = 
  g \left(
    \begin{array}{c}
      h \\ 
      w
    \end{array}
    \right) \\
\\
g \left(
  \begin{array}{c}
    h \\ 
    w
  \end{array}
  \right) &\sim N \left( 
  \begin{array}{c} 
    \mu_h \\ 
    \mu_w 
    \end{array}, 
    \left( 
    \begin{array}{cc}
      \sigma^2_h & 0 \\
      0 & \sigma^2_w
    \end{array}
      \right)  \right) \\
\\
  &\equiv N( \boldsymbol{\mu}, \Sigma)
\end{aligned}
$$

Then, via the delta method (or Taylor approximation) [@Doob1935], we can derive the variance of our estimates of *pHOS*:

$$
\begin{aligned}
Var(g) &= \left( \frac{ \partial g}{\partial h}, \frac{ \partial g}{\partial w} \right) \Sigma \left( \begin{array}{c} \frac{ \partial g}{\partial h} \\ \frac{ \partial g}{\partial w} \end{array} \right) \\
\\
&= \left( \frac{w}{(h+w)^2}, \frac{h}{(h+w)^2} \right) 
  \left( 
    \begin{array}{cc}
      \sigma^2_h & 0 \\
      0 & \sigma^2_w
    \end{array}
  \right) 
  \left( 
    \begin{array}{c}
    \frac{w}{(h+w)^2} \\
    \frac{h}{(h+w)^2}
    \end{array}
  \right)
\\
&= \left( \frac{w \sigma^2_h}{(h+w)^2}, \frac{h \sigma^2_w}{(h+w)^2} \right) 
    \left( 
    \begin{array}{c}
    \frac{w}{(h+w)^2} \\
    \frac{h}{(h+w)^2}
    \end{array}
  \right)
\\
&= \frac{w^2 \sigma^2_h + h^2 \sigma^2_w}{(h+w)^4},
\end{aligned}
$$

so the standard error of *pHOS* is

$$
SE(g) = \frac{w \sigma_h + h \sigma_w}{(h+w)^2},
$$

which implies that the CV of *pHOS* can be derived as

$$
\begin{aligned}
CV(g) &= \frac{SE(g)}{g} \\
\\
&= \frac{w \sigma_h + h \sigma_w}{(h+w)^2} * \frac{(h+w)}{h} \\
\\
&= \frac{w \sigma_h + h \sigma_w}{h(h+w)}\\
\\
&= \frac{h \sigma_w}{h(h+w)} + \frac{w \sigma_h}{h(h+w)} \\
\\
&= \frac{\sigma_w}{(h + w)} + \frac{w}{(h+w)} * \frac{\sigma_h}{h} \\
\\
&= \frac{w}{(h+w)} \left( \frac{\sigma_w}{w} + \frac{\sigma_h}{h} \right),
\end{aligned}
$$

which is a combination of the proportion of wild fish, the CV of estimate of wild fish and the CV of the estimate of hatchery fish.

In other words, we can predict the CV of *pHOS* for a variety of situations for a given branch *i* by varying the percent wild fish in a stream, and the precision (or CV) of our escapement estimates of wild and hatchery fish in branch *i*. We selected several levels of precision in our estimates of wild fish, with CVs from 0.01 to 0.5, and a range of precision in our hatchery estimates, with CVs from 0 to 1.5, and then calculated the predicted CV of *pHOS* on those values.

# Results

## Simulation

We predicted the CV of *pHOS* across a range of values for both hatchery escapement CV (0 - 1.5) and proportion wild (i.e., inverse of *pHOS*). The results are shown in *Figure X*.

```{r tradeoff_fig}
# proportion of wild fish in the stream
propWild = seq(0.05, 0.95, 0.05)
# CV of the estimate of wild fish
cvW = c(0.01, 0.05, 0.1, 0.15, 0.2, 0.25, 0.3, 0.4, 0.5)
# CV of the estimate of hatchery fish
cvH = seq(0, 1.5, 0.05)

crossing(propWild, cvW, cvH) %>%
  mutate(pHOS = 1 - propWild,
         CV = propWild * (cvW + cvH)) %>%
  mutate_at(vars(propWild, cvW),
            list(as.factor)) %>%
  ggplot(aes(x = cvH,
             y = CV,
             group = propWild,
             color = as.numeric(as.character(propWild)))) +
  scale_color_viridis_c(direction = -1,
                        end = 0.9,
                        option = 'C') +
  geom_line() +
  # geom_point() +
  geom_hline(yintercept = 0.15,
             linetype = 2,
             color = 'black') +
  # geom_vline(xintercept = 0.15,
  #            linetype = 2,
  #            color = 'black') +
  theme_bw() +
  theme(legend.position = 'bottom') +
  facet_wrap(~ cvW,
             ncol = 3) +
  # facet_grid(propWild ~ cvW) +
  labs(x = 'CV of Hatchery Escp.',
       y = 'CV of pHOS',
       color = '% Wild')
```

The general patterns show that as the proportion of wild fish in the stream descreases, the precision of *pHOS* improves for a given precision level of wild and hatchery escapement estimates. Also, as the precision of the wild estimates improves (i.e. smaller CV), there are more scenarios under which the precision of the *pHOS* estimate is reasonable. As a reference, the CVs of the estimates for spring/summer Chinook escapement to the Lemhi range from 0.1 to 0.25 for years 2010 - 2018. 

Another way to look at it would be to examine the maximum CV of hatchery estimates that would provide a reasonable estimate of *pHOS* for a given proportion of wild fish and precision of wild escapement. One way to visualize these results in in the plot below.

```{r}
cvThres = 0.15
crossing(propWild = seq(0, 1, 0.01), # proportion of wild fish in the stream
         # CV of the estimate of wild fish
         cvW = seq(0, 1, 0.01),
         # CV of the estimate of hatchery fish
         cvH = seq(0, 1.5, 0.03)) %>%
  mutate(pHOS = 1 - propWild,
         CV = propWild * (cvW + cvH)) %>%
  group_by(propWild, cvW) %>%
  summarise(nTot = n(),
            nPrec = sum(CV <= cvThres),
            maxHcv = max(cvH[CV <= cvThres])) %>%
  ungroup() %>%
  ggplot(aes(x = cvW,
             y = propWild)) +
  geom_tile(aes(fill = maxHcv)) +
  geom_contour(aes(z = maxHcv),
               color = 'black',
               bins = 10) +
  theme_minimal() +
  geom_text(x = 0.75,
            y = 0.75,
            hjust = 'inward',
            vjust = 'inward',
            label = paste0('CV > ', cvThres, '%')) +
  scale_fill_viridis_c(na.value = 'gray90',
                       begin = 0.2) +
  labs(x = 'CV of Wild Escp.',
       y = '% Wild',
       fill = 'Max CV\nHatch Est.')

```

From this plot, it is clear that as long as the proportion of wild fish in a stream is below a certain threshold (around 10%), then regardless of the CV of wild or hatchery escapement, reasonable precision of *pHOS* will be obtained. 

## Assumptions From Scope of Work

* What are the appropriate transition probabilities for hatchery fish along model branches? Need to consider harvest of hatchery fish. Presumably transition probabilities are lower for hatchery fish (relative to natural origin fish) due to harvest.
* Do hatchery fish mimic movement of wild fish? Probably not, due to the location of origin hatcheries and releases.
* Do some branches contain 0 hatchery fish?
* Should branches further upstream of LGR automatically include lower transition probabilities due to fishing on the mainstem?
* Do we need to accomodate time-varying movement probabilities in the simulation?
* Appropriate detection probabilities for each detection node in the simulation model.
* We must assume a fraction of hatchery fish will be harvested prior to reaching tributary habitats.
* How many total hatchery fish escape past LGR? We can run STADEM to determine range of values over the last several years.

Alternatively, to determine the appropriate level of tagging, we may examine the last several years of DABOM results and focus on the number of tags observed within a few different tributaries and the level of precision of the accompanying escapement estimates, accounting for detection probability. We could then build a relationship to predict the precision based on the number of tags detected and the detection probability. After making some assumptions about the transition probability of hatchery fish to a particular tributary, we can use the estimate of detection probability to predict the precision of the escapement estimate under a variety of tagging rates.

## Comments from Lance H. August 5, 2019

I would contact Busack directly, we never saw any specific analysis only Craig’s description of how low a confidence we would have given the low tag rates and detection rates at a single array in a  single year basis.  Also some of the issues we had with Craig’s analysis was his assumption that straying was equal across the landscape, as opposed to straying being more likely near the release points, the effect of transportation on straying, the ability to aggregate information from multiple years to further understand patterns in straying, and a few other things that I don’t have on the top of my head.  

## Deliverable/Outcome

A statistical evaluation of bias/reliability of pHOS estimates that could be achieved for Snake River spring/summer Chinook salmon and steelhead given varying rates of HOR PIT tagging at LGR.

## Additional Considerations and Assumptions

* Is 15% CV for pHOS an appropriate, or even achievable, goal?

## Potential Useful Data Sources

## Simulation Description

The $\hat{pHOS}$ to a given location $j$ can simply be estimated as the ratio of all hatchery fish returning to a location, divided by total (i.e., hatchery and wild) fish returning. And in the case of hatchery fish, we need to account for broodstock removal and harves (if any).

$$\hat{pHOS} = \frac{\hat{N}_{j,H} - (Broodstock + Harvest)}{\hat{N}_{j,W} + (\hat{N}_{j,H} - (Broodstock + Harvest))}$$
Typically, in STADEM and DABOM we estimate weekly escapement past LGR (STADEM) and weekly movement probabilities (DABOM). However, for the purposes of this simulation, perhaps we can assume similar run timings between hatchery and wild fish and among branches. And thus, wild and hatchery abundance to a given location $j$ could be simply estimated as
$$\hat{N}_{j,H} = X_H\psi_{j,H}$$
$$\hat{N}_{j,W} = X_W\psi_{j,W}$$
where $X$ is the escapement past LGR and $\psi$ is the movement probability for hatchery ($H$) and wild ($W$) fish, respectively.

# References

Camacho, C.A., K.K. Wright, J. Powell, W.C. Schrader, T. Copeland, M.W. Ackerman, M. Dobos, M.P. Corsi, and M.R. Campbell. 2017. Wild adult steelehad and Chinook salmon abundance and composition at Lower Granite Dam, spawn years 2009-2016. Cumulative Report 2009 through 2016. Idaho Department of Fish and Game Report 17-06.

Doob, J.L. 1935. The limiting distributions of certain statistics. The Annals of Mathematical Statistics 6:160-169.

Orme, R. and R. Kinzer. 2018. Integrated In-stream PIT Tag Detection System Operations and Maintenance; PIT Tag Based Adult Escapement Estimates for Spawn Years 2016 and 2017. Nez Perce Tribe Department of Fisheries Resource Management. Prepared for: Quantititative Consultants, Inc.
